import * as THREE from 'three';
import { OrbitControls } from 'three/examples/jsm/controls/OrbitControls.js';

const jetcmap = [[0.0, 0.0, 0.5], [0.0, 0.0, 0.517825311942959], [0.0, 0.0, 0.535650623885918], [0.0, 0.0, 0.553475935828877], [0.0, 0.0, 0.571301247771836], [0.0, 0.0, 0.589126559714795], [0.0, 0.0, 0.606951871657754], [0.0, 0.0, 0.624777183600713], [0.0, 0.0, 0.642602495543672], [0.0, 0.0, 0.660427807486631], [0.0, 0.0, 0.67825311942959], [0.0, 0.0, 0.696078431372549], [0.0, 0.0, 0.713903743315508], [0.0, 0.0, 0.731729055258467], [0.0, 0.0, 0.749554367201426], [0.0, 0.0, 0.767379679144385], [0.0, 0.0, 0.785204991087344], [0.0, 0.0, 0.803030303030303], [0.0, 0.0, 0.820855614973262], [0.0, 0.0, 0.838680926916221], [0.0, 0.0, 0.85650623885918], [0.0, 0.0, 0.874331550802139], [0.0, 0.0, 0.892156862745098], [0.0, 0.0, 0.909982174688057], [0.0, 0.0, 0.927807486631016], [0.0, 0.0, 0.945632798573975], [0.0, 0.0, 0.963458110516934], [0.0, 0.0, 0.981283422459893], [0.0, 0.0, 0.999108734402852], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.0, 1.0], [0.0, 0.00196078431372549, 1.0], [0.0, 0.0176470588235293, 1.0], [0.0, 0.03333333333333333, 1.0], [0.0, 0.049019607843137254, 1.0], [0.0, 0.06470588235294118, 1.0], [0.0, 0.08039215686274499, 1.0], [0.0, 0.09607843137254903, 1.0], [0.0, 0.11176470588235295, 1.0], [0.0, 0.12745098039215685, 1.0], [0.0, 0.14313725490196066, 1.0], [0.0, 0.1588235294117647, 1.0], [0.0, 0.17450980392156862, 1.0], [0.0, 0.19019607843137254, 1.0], [0.0, 0.20588235294117635, 1.0], [0.0, 0.22156862745098038, 1.0], [0.0, 0.2372549019607843, 1.0], [0.0, 0.2529411764705882, 1.0], [0.0, 0.26862745098039204, 1.0], [0.0, 0.28431372549019607, 1.0], [0.0, 0.3, 1.0], [0.0, 0.3156862745098039, 1.0], [0.0, 0.3313725490196077, 1.0], [0.0, 0.34705882352941175, 1.0], [0.0, 0.3627450980392157, 1.0], [0.0, 0.3784313725490196, 1.0], [0.0, 0.3941176470588234, 1.0], [0.0, 0.40980392156862744, 1.0], [0.0, 0.42549019607843136, 1.0], [0.0, 0.4411764705882353, 1.0], [0.0, 0.4568627450980391, 1.0], [0.0, 0.4725490196078431, 1.0], [0.0, 0.48823529411764705, 1.0], [0.0, 0.503921568627451, 1.0], [0.0, 0.5196078431372549, 1.0], [0.0, 0.5352941176470586, 1.0], [0.0, 0.5509803921568628, 1.0], [0.0, 0.5666666666666667, 1.0], [0.0, 0.5823529411764706, 1.0], [0.0, 0.5980392156862745, 1.0], [0.0, 0.6137254901960785, 1.0], [0.0, 0.6294117647058823, 1.0], [0.0, 0.6450980392156863, 1.0], [0.0, 0.66078431372549, 1.0], [0.0, 0.6764705882352942, 1.0], [0.0, 0.692156862745098, 1.0], [0.0, 0.707843137254902, 1.0], [0.0, 0.7235294117647059, 1.0], [0.0, 0.7392156862745098, 1.0], [0.0, 0.7549019607843137, 1.0], [0.0, 0.7705882352941177, 1.0], [0.0, 0.7862745098039213, 1.0], [0.0, 0.8019607843137255, 1.0], [0.0, 0.8176470588235294, 1.0], [0.0, 0.8333333333333334, 1.0], [0.0, 0.8490196078431372, 1.0], [0.0, 0.8647058823529412, 0.9962049335863378], [0.0, 0.8803921568627451, 0.9835547122074637], [0.0, 0.8960784313725491, 0.9709044908285895], [0.009487666034155417, 0.9117647058823527, 0.9582542694497156], [0.022137887413029723, 0.9274509803921569, 0.9456040480708413], [0.03478810879190385, 0.9431372549019608, 0.9329538266919671], [0.04743833017077798, 0.9588235294117647, 0.920303605313093], [0.06008855154965211, 0.9745098039215686, 0.9076533839342189], [0.07273877292852624, 0.9901960784313726, 0.8950031625553447], [0.08538899430740036, 1.0, 0.8823529411764706], [0.0980392156862745, 1.0, 0.8697027197975965], [0.11068943706514844, 1.0, 0.8570524984187226], [0.12333965844402275, 1.0, 0.8444022770398483], [0.13598987982289687, 1.0, 0.8317520556609741], [0.148640101201771, 1.0, 0.8191018342820999], [0.16129032258064513, 1.0, 0.8064516129032259], [0.17394054395951927, 1.0, 0.7938013915243517], [0.1865907653383934, 1.0, 0.7811511701454776], [0.19924098671726753, 1.0, 0.7685009487666035], [0.21189120809614148, 1.0, 0.7558507273877295], [0.2245414294750158, 1.0, 0.7432005060088551], [0.2371916508538899, 1.0, 0.7305502846299811], [0.24984187223276405, 1.0, 0.717900063251107], [0.26249209361163817, 1.0, 0.7052498418722328], [0.2751423149905123, 1.0, 0.6925996204933587], [0.2877925363693864, 1.0, 0.6799493991144845], [0.30044275774826057, 1.0, 0.6672991777356103], [0.3130929791271345, 1.0, 0.6546489563567364], [0.3257432005060088, 1.0, 0.6419987349778622], [0.3383934218848829, 1.0, 0.629348513598988], [0.3510436432637571, 1.0, 0.6166982922201139], [0.3636938646426312, 1.0, 0.6040480708412397], [0.3763440860215053, 1.0, 0.5913978494623656], [0.38899430740037944, 1.0, 0.5787476280834916], [0.4016445287792536, 1.0, 0.5660974067046174], [0.4142947501581275, 1.0, 0.5534471853257434], [0.42694497153700184, 1.0, 0.540796963946869], [0.43959519291587595, 1.0, 0.5281467425679949], [0.45224541429475007, 1.0, 0.5154965211891208], [0.46489563567362424, 1.0, 0.5028462998102468], [0.47754585705249836, 1.0, 0.4901960784313726], [0.4901960784313725, 1.0, 0.4775458570524984], [0.5028462998102466, 1.0, 0.46489563567362435], [0.5154965211891207, 1.0, 0.4522454142947502], [0.5281467425679949, 1.0, 0.439595192915876], [0.5407969639468686, 1.0, 0.4269449715370023], [0.5534471853257431, 1.0, 0.4142947501581278], [0.5660974067046173, 1.0, 0.4016445287792536], [0.5787476280834913, 1.0, 0.38899430740037955], [0.5913978494623655, 1.0, 0.3763440860215054], [0.6040480708412397, 1.0, 0.3636938646426312], [0.6166982922201137, 1.0, 0.35104364326375714], [0.6293485135989879, 1.0, 0.338393421884883], [0.641998734977862, 1.0, 0.3257432005060089], [0.6546489563567361, 1.0, 0.31309297912713474], [0.6672991777356103, 1.0, 0.30044275774826057], [0.6799493991144844, 1.0, 0.2877925363693865], [0.6925996204933585, 1.0, 0.27514231499051234], [0.7052498418722326, 1.0, 0.26249209361163817], [0.7179000632511068, 1.0, 0.2498418722327641], [0.730550284629981, 1.0, 0.23719165085388993], [0.7432005060088547, 1.0, 0.2245414294750162], [0.7558507273877292, 1.0, 0.2118912080961417], [0.7685009487666034, 1.0, 0.19924098671726753], [0.7811511701454774, 1.0, 0.18659076533839347], [0.7938013915243516, 1.0, 0.1739405439595193], [0.8064516129032256, 1.0, 0.16129032258064513], [0.8191018342820998, 1.0, 0.14864010120177107], [0.831752055660974, 1.0, 0.1359898798228969], [0.844402277039848, 1.0, 0.12333965844402273], [0.8570524984187222, 1.0, 0.11068943706514867], [0.8697027197975963, 1.0, 0.0980392156862745], [0.8823529411764705, 1.0, 0.08538899430740043], [0.8950031625553446, 1.0, 0.07273877292852626], [0.9076533839342187, 1.0, 0.06008855154965209], [0.9203036053130929, 1.0, 0.04743833017077803], [0.932953826691967, 1.0, 0.03478810879190386], [0.9456040480708408, 0.9883805374001459, 0.022137887413030133], [0.9582542694497153, 0.973856209150327, 0.009487666034155628], [0.9709044908285893, 0.9593318809005086, 0.0], [0.9835547122074635, 0.9448075526506902, 0.0], [0.9962049335863377, 0.9302832244008717, 0.0], [1.0, 0.9157588961510532, 0.0], [1.0, 0.9012345679012348, 0.0], [1.0, 0.8867102396514164, 0.0], [1.0, 0.872185911401598, 0.0], [1.0, 0.8576615831517794, 0.0], [1.0, 0.843137254901961, 0.0], [1.0, 0.8286129266521426, 0.0], [1.0, 0.8140885984023241, 0.0], [1.0, 0.7995642701525056, 0.0], [1.0, 0.7850399419026872, 0.0], [1.0, 0.7705156136528688, 0.0], [1.0, 0.7559912854030507, 0.0], [1.0, 0.741466957153232, 0.0], [1.0, 0.7269426289034134, 0.0], [1.0, 0.712418300653595, 0.0], [1.0, 0.6978939724037765, 0.0], [1.0, 0.6833696441539581, 0.0], [1.0, 0.6688453159041396, 0.0], [1.0, 0.6543209876543212, 0.0], [1.0, 0.6397966594045028, 0.0], [1.0, 0.6252723311546844, 0.0], [1.0, 0.6107480029048659, 0.0], [1.0, 0.5962236746550474, 0.0], [1.0, 0.5816993464052289, 0.0], [1.0, 0.5671750181554105, 0.0], [1.0, 0.5526506899055921, 0.0], [1.0, 0.5381263616557737, 0.0], [1.0, 0.5236020334059556, 0.0], [1.0, 0.5090777051561368, 0.0], [1.0, 0.4945533769063183, 0.0], [1.0, 0.48002904865649987, 0.0], [1.0, 0.46550472040668145, 0.0], [1.0, 0.4509803921568629, 0.0], [1.0, 0.4364560639070445, 0.0], [1.0, 0.4219317356572261, 0.0], [1.0, 0.40740740740740755, 0.0], [1.0, 0.39288307915758913, 0.0], [1.0, 0.3783587509077707, 0.0], [1.0, 0.3638344226579523, 0.0], [1.0, 0.34931009440813376, 0.0], [1.0, 0.33478576615831535, 0.0], [1.0, 0.3202614379084969, 0.0], [1.0, 0.3057371096586785, 0.0], [1.0, 0.2912127814088604, 0.0], [1.0, 0.27668845315904156, 0.0], [1.0, 0.26216412490922314, 0.0], [1.0, 0.24763979665940472, 0.0], [1.0, 0.2331154684095862, 0.0], [1.0, 0.21859114015976777, 0.0], [1.0, 0.20406681190994935, 0.0], [1.0, 0.18954248366013093, 0.0], [1.0, 0.1750181554103124, 0.0], [1.0, 0.16049382716049398, 0.0], [1.0, 0.14596949891067557, 0.0], [1.0, 0.13144517066085715, 0.0], [1.0, 0.11692084241103862, 0.0], [1.0, 0.1023965141612202, 0.0], [1.0, 0.08787218591140178, 0.0], [0.9991087344028523, 0.07334785766158336, 0.0], [0.9812834224598939, 0.058823529411765274, 0.0], [0.9634581105169343, 0.04429920116194641, 0.0], [0.9456327985739753, 0.029774872912127992, 0.0], [0.9278074866310163, 0.015250544662309573, 0.0], [0.9099821746880573, 0.0007262164124910431, 0.0], [0.8921568627450983, 0.0, 0.0], [0.8743315508021392, 0.0, 0.0], [0.8565062388591802, 0.0, 0.0], [0.8386809269162212, 0.0, 0.0], [0.8208556149732622, 0.0, 0.0], [0.8030303030303032, 0.0, 0.0], [0.7852049910873442, 0.0, 0.0], [0.7673796791443852, 0.0, 0.0], [0.7495543672014262, 0.0, 0.0], [0.7317290552584672, 0.0, 0.0], [0.7139037433155082, 0.0, 0.0], [0.6960784313725497, 0.0, 0.0], [0.6782531194295901, 0.0, 0.0], [0.6604278074866311, 0.0, 0.0], [0.6426024955436721, 0.0, 0.0], [0.6247771836007131, 0.0, 0.0], [0.606951871657754, 0.0, 0.0], [0.589126559714795, 0.0, 0.0], [0.571301247771836, 0.0, 0.0], [0.553475935828877, 0.0, 0.0], [0.535650623885918, 0.0, 0.0], [0.517825311942959, 0.0, 0.0], [0.5, 0.0, 0.0]];
const viridiscmap = [[0.267004, 0.004874, 0.329415], [0.26851, 0.009605, 0.335427], [0.269944, 0.014625, 0.341379], [0.271305, 0.019942, 0.347269], [0.272594, 0.025563, 0.353093], [0.273809, 0.031497, 0.358853], [0.274952, 0.037752, 0.364543], [0.276022, 0.044167, 0.370164], [0.277018, 0.050344, 0.375715], [0.277941, 0.056324, 0.381191], [0.278791, 0.062145, 0.386592], [0.279566, 0.067836, 0.391917], [0.280267, 0.073417, 0.397163], [0.280894, 0.078907, 0.402329], [0.281446, 0.08432, 0.407414], [0.281924, 0.089666, 0.412415], [0.282327, 0.094955, 0.417331], [0.282656, 0.100196, 0.42216], [0.28291, 0.105393, 0.426902], [0.283091, 0.110553, 0.431554], [0.283197, 0.11568, 0.436115], [0.283229, 0.120777, 0.440584], [0.283187, 0.125848, 0.44496], [0.283072, 0.130895, 0.449241], [0.282884, 0.13592, 0.453427], [0.282623, 0.140926, 0.457517], [0.28229, 0.145912, 0.46151], [0.281887, 0.150881, 0.465405], [0.281412, 0.155834, 0.469201], [0.280868, 0.160771, 0.472899], [0.280255, 0.165693, 0.476498], [0.279574, 0.170599, 0.479997], [0.278826, 0.17549, 0.483397], [0.278012, 0.180367, 0.486697], [0.277134, 0.185228, 0.489898], [0.276194, 0.190074, 0.493001], [0.275191, 0.194905, 0.496005], [0.274128, 0.199721, 0.498911], [0.273006, 0.20452, 0.501721], [0.271828, 0.209303, 0.504434], [0.270595, 0.214069, 0.507052], [0.269308, 0.218818, 0.509577], [0.267968, 0.223549, 0.512008], [0.26658, 0.228262, 0.514349], [0.265145, 0.232956, 0.516599], [0.263663, 0.237631, 0.518762], [0.262138, 0.242286, 0.520837], [0.260571, 0.246922, 0.522828], [0.258965, 0.251537, 0.524736], [0.257322, 0.25613, 0.526563], [0.255645, 0.260703, 0.528312], [0.253935, 0.265254, 0.529983], [0.252194, 0.269783, 0.531579], [0.250425, 0.27429, 0.533103], [0.248629, 0.278775, 0.534556], [0.246811, 0.283237, 0.535941], [0.244972, 0.287675, 0.53726], [0.243113, 0.292092, 0.538516], [0.241237, 0.296485, 0.539709], [0.239346, 0.300855, 0.540844], [0.237441, 0.305202, 0.541921], [0.235526, 0.309527, 0.542944], [0.233603, 0.313828, 0.543914], [0.231674, 0.318106, 0.544834], [0.229739, 0.322361, 0.545706], [0.227802, 0.326594, 0.546532], [0.225863, 0.330805, 0.547314], [0.223925, 0.334994, 0.548053], [0.221989, 0.339161, 0.548752], [0.220057, 0.343307, 0.549413], [0.21813, 0.347432, 0.550038], [0.21621, 0.351535, 0.550627], [0.214298, 0.355619, 0.551184], [0.212395, 0.359683, 0.55171], [0.210503, 0.363727, 0.552206], [0.208623, 0.367752, 0.552675], [0.206756, 0.371758, 0.553117], [0.204903, 0.375746, 0.553533], [0.203063, 0.379716, 0.553925], [0.201239, 0.38367, 0.554294], [0.19943, 0.387607, 0.554642], [0.197636, 0.391528, 0.554969], [0.19586, 0.395433, 0.555276], [0.1941, 0.399323, 0.555565], [0.192357, 0.403199, 0.555836], [0.190631, 0.407061, 0.556089], [0.188923, 0.41091, 0.556326], [0.187231, 0.414746, 0.556547], [0.185556, 0.41857, 0.556753], [0.183898, 0.422383, 0.556944], [0.182256, 0.426184, 0.55712], [0.180629, 0.429975, 0.557282], [0.179019, 0.433756, 0.55743], [0.177423, 0.437527, 0.557565], [0.175841, 0.44129, 0.557685], [0.174274, 0.445044, 0.557792], [0.172719, 0.448791, 0.557885], [0.171176, 0.45253, 0.557965], [0.169646, 0.456262, 0.55803], [0.168126, 0.459988, 0.558082], [0.166617, 0.463708, 0.558119], [0.165117, 0.467423, 0.558141], [0.163625, 0.471133, 0.558148], [0.162142, 0.474838, 0.55814], [0.160665, 0.47854, 0.558115], [0.159194, 0.482237, 0.558073], [0.157729, 0.485932, 0.558013], [0.15627, 0.489624, 0.557936], [0.154815, 0.493313, 0.55784], [0.153364, 0.497, 0.557724], [0.151918, 0.500685, 0.557587], [0.150476, 0.504369, 0.55743], [0.149039, 0.508051, 0.55725], [0.147607, 0.511733, 0.557049], [0.14618, 0.515413, 0.556823], [0.144759, 0.519093, 0.556572], [0.143343, 0.522773, 0.556295], [0.141935, 0.526453, 0.555991], [0.140536, 0.530132, 0.555659], [0.139147, 0.533812, 0.555298], [0.13777, 0.537492, 0.554906], [0.136408, 0.541173, 0.554483], [0.135066, 0.544853, 0.554029], [0.133743, 0.548535, 0.553541], [0.132444, 0.552216, 0.553018], [0.131172, 0.555899, 0.552459], [0.129933, 0.559582, 0.551864], [0.128729, 0.563265, 0.551229], [0.127568, 0.566949, 0.550556], [0.126453, 0.570633, 0.549841], [0.125394, 0.574318, 0.549086], [0.124395, 0.578002, 0.548287], [0.123463, 0.581687, 0.547445], [0.122606, 0.585371, 0.546557], [0.121831, 0.589055, 0.545623], [0.121148, 0.592739, 0.544641], [0.120565, 0.596422, 0.543611], [0.120092, 0.600104, 0.54253], [0.119738, 0.603785, 0.5414], [0.119512, 0.607464, 0.540218], [0.119423, 0.611141, 0.538982], [0.119483, 0.614817, 0.537692], [0.119699, 0.61849, 0.536347], [0.120081, 0.622161, 0.534946], [0.120638, 0.625828, 0.533488], [0.12138, 0.629492, 0.531973], [0.122312, 0.633153, 0.530398], [0.123444, 0.636809, 0.528763], [0.12478, 0.640461, 0.527068], [0.126326, 0.644107, 0.525311], [0.128087, 0.647749, 0.523491], [0.130067, 0.651384, 0.521608], [0.132268, 0.655014, 0.519661], [0.134692, 0.658636, 0.517649], [0.137339, 0.662252, 0.515571], [0.14021, 0.665859, 0.513427], [0.143303, 0.669459, 0.511215], [0.146616, 0.67305, 0.508936], [0.150148, 0.676631, 0.506589], [0.153894, 0.680203, 0.504172], [0.157851, 0.683765, 0.501686], [0.162016, 0.687316, 0.499129], [0.166383, 0.690856, 0.496502], [0.170948, 0.694384, 0.493803], [0.175707, 0.6979, 0.491033], [0.180653, 0.701402, 0.488189], [0.185783, 0.704891, 0.485273], [0.19109, 0.708366, 0.482284], [0.196571, 0.711827, 0.479221], [0.202219, 0.715272, 0.476084], [0.20803, 0.718701, 0.472873], [0.214, 0.722114, 0.469588], [0.220124, 0.725509, 0.466226], [0.226397, 0.728888, 0.462789], [0.232815, 0.732247, 0.459277], [0.239374, 0.735588, 0.455688], [0.24607, 0.73891, 0.452024], [0.252899, 0.742211, 0.448284], [0.259857, 0.745492, 0.444467], [0.266941, 0.748751, 0.440573], [0.274149, 0.751988, 0.436601], [0.281477, 0.755203, 0.432552], [0.288921, 0.758394, 0.428426], [0.296479, 0.761561, 0.424223], [0.304148, 0.764704, 0.419943], [0.311925, 0.767822, 0.415586], [0.319809, 0.770914, 0.411152], [0.327796, 0.77398, 0.40664], [0.335885, 0.777018, 0.402049], [0.344074, 0.780029, 0.397381], [0.35236, 0.783011, 0.392636], [0.360741, 0.785964, 0.387814], [0.369214, 0.788888, 0.382914], [0.377779, 0.791781, 0.377939], [0.386433, 0.794644, 0.372886], [0.395174, 0.797475, 0.367757], [0.404001, 0.800275, 0.362552], [0.412913, 0.803041, 0.357269], [0.421908, 0.805774, 0.35191], [0.430983, 0.808473, 0.346476], [0.440137, 0.811138, 0.340967], [0.449368, 0.813768, 0.335384], [0.458674, 0.816363, 0.329727], [0.468053, 0.818921, 0.323998], [0.477504, 0.821444, 0.318195], [0.487026, 0.823929, 0.312321], [0.496615, 0.826376, 0.306377], [0.506271, 0.828786, 0.300362], [0.515992, 0.831158, 0.294279], [0.525776, 0.833491, 0.288127], [0.535621, 0.835785, 0.281908], [0.545524, 0.838039, 0.275626], [0.555484, 0.840254, 0.269281], [0.565498, 0.84243, 0.262877], [0.575563, 0.844566, 0.256415], [0.585678, 0.846661, 0.249897], [0.595839, 0.848717, 0.243329], [0.606045, 0.850733, 0.236712], [0.616293, 0.852709, 0.230052], [0.626579, 0.854645, 0.223353], [0.636902, 0.856542, 0.21662], [0.647257, 0.8584, 0.209861], [0.657642, 0.860219, 0.203082], [0.668054, 0.861999, 0.196293], [0.678489, 0.863742, 0.189503], [0.688944, 0.865448, 0.182725], [0.699415, 0.867117, 0.175971], [0.709898, 0.868751, 0.169257], [0.720391, 0.87035, 0.162603], [0.730889, 0.871916, 0.156029], [0.741388, 0.873449, 0.149561], [0.751884, 0.874951, 0.143228], [0.762373, 0.876424, 0.137064], [0.772852, 0.877868, 0.131109], [0.783315, 0.879285, 0.125405], [0.79376, 0.880678, 0.120005], [0.804182, 0.882046, 0.114965], [0.814576, 0.883393, 0.110347], [0.82494, 0.88472, 0.106217], [0.83527, 0.886029, 0.102646], [0.845561, 0.887322, 0.099702], [0.85581, 0.888601, 0.097452], [0.866013, 0.889868, 0.095953], [0.876168, 0.891125, 0.09525], [0.886271, 0.892374, 0.095374], [0.89632, 0.893616, 0.096335], [0.906311, 0.894855, 0.098125], [0.916242, 0.896091, 0.100717], [0.926106, 0.89733, 0.104071], [0.935904, 0.89857, 0.108131], [0.945636, 0.899815, 0.112838], [0.9553, 0.901065, 0.118128], [0.964894, 0.902323, 0.123941], [0.974417, 0.90359, 0.130215], [0.983868, 0.904867, 0.136897], [0.993248, 0.906157, 0.143936]];
const infernocmap = [[0.001462, 0.000466, 0.013866], [0.002267, 0.00127, 0.01857], [0.003299, 0.002249, 0.024239], [0.004547, 0.003392, 0.030909], [0.006006, 0.004692, 0.038558], [0.007676, 0.006136, 0.046836], [0.009561, 0.007713, 0.055143], [0.011663, 0.009417, 0.06346], [0.013995, 0.011225, 0.071862], [0.016561, 0.013136, 0.080282], [0.019373, 0.015133, 0.088767], [0.022447, 0.017199, 0.097327], [0.025793, 0.019331, 0.10593], [0.029432, 0.021503, 0.114621], [0.033385, 0.023702, 0.123397], [0.037668, 0.025921, 0.132232], [0.042253, 0.028139, 0.141141], [0.046915, 0.030324, 0.150164], [0.051644, 0.032474, 0.159254], [0.056449, 0.034569, 0.168414], [0.06134, 0.03659, 0.177642], [0.066331, 0.038504, 0.186962], [0.071429, 0.040294, 0.196354], [0.076637, 0.041905, 0.205799], [0.081962, 0.043328, 0.215289], [0.087411, 0.044556, 0.224813], [0.09299, 0.045583, 0.234358], [0.098702, 0.046402, 0.243904], [0.104551, 0.047008, 0.25343], [0.110536, 0.047399, 0.262912], [0.116656, 0.047574, 0.272321], [0.122908, 0.047536, 0.281624], [0.129285, 0.047293, 0.290788], [0.135778, 0.046856, 0.299776], [0.142378, 0.046242, 0.308553], [0.149073, 0.045468, 0.317085], [0.15585, 0.044559, 0.325338], [0.162689, 0.043554, 0.333277], [0.169575, 0.042489, 0.340874], [0.176493, 0.041402, 0.348111], [0.183429, 0.040329, 0.354971], [0.190367, 0.039309, 0.361447], [0.197297, 0.0384, 0.367535], [0.204209, 0.037632, 0.373238], [0.211095, 0.03703, 0.378563], [0.217949, 0.036615, 0.383522], [0.224763, 0.036405, 0.388129], [0.231538, 0.036405, 0.3924], [0.238273, 0.036621, 0.396353], [0.244967, 0.037055, 0.400007], [0.25162, 0.037705, 0.403378], [0.258234, 0.038571, 0.406485], [0.26481, 0.039647, 0.409345], [0.271347, 0.040922, 0.411976], [0.27785, 0.042353, 0.414392], [0.284321, 0.043933, 0.416608], [0.290763, 0.045644, 0.418637], [0.297178, 0.04747, 0.420491], [0.303568, 0.049396, 0.422182], [0.309935, 0.051407, 0.423721], [0.316282, 0.05349, 0.425116], [0.32261, 0.055634, 0.426377], [0.328921, 0.057827, 0.427511], [0.335217, 0.06006, 0.428524], [0.3415, 0.062325, 0.429425], [0.347771, 0.064616, 0.430217], [0.354032, 0.066925, 0.430906], [0.360284, 0.069247, 0.431497], [0.366529, 0.071579, 0.431994], [0.372768, 0.073915, 0.4324], [0.379001, 0.076253, 0.432719], [0.385228, 0.078591, 0.432955], [0.391453, 0.080927, 0.433109], [0.397674, 0.083257, 0.433183], [0.403894, 0.08558, 0.433179], [0.410113, 0.087896, 0.433098], [0.416331, 0.090203, 0.432943], [0.422549, 0.092501, 0.432714], [0.428768, 0.09479, 0.432412], [0.434987, 0.097069, 0.432039], [0.441207, 0.099338, 0.431594], [0.447428, 0.101597, 0.43108], [0.453651, 0.103848, 0.430498], [0.459875, 0.106089, 0.429846], [0.4661, 0.108322, 0.429125], [0.472328, 0.110547, 0.428334], [0.478558, 0.112764, 0.427475], [0.484789, 0.114974, 0.426548], [0.491022, 0.117179, 0.425552], [0.497257, 0.119379, 0.424488], [0.503493, 0.121575, 0.423356], [0.50973, 0.123769, 0.422156], [0.515967, 0.12596, 0.420887], [0.522206, 0.12815, 0.419549], [0.528444, 0.130341, 0.418142], [0.534683, 0.132534, 0.416667], [0.54092, 0.134729, 0.415123], [0.547157, 0.136929, 0.413511], [0.553392, 0.139134, 0.411829], [0.559624, 0.141346, 0.410078], [0.565854, 0.143567, 0.408258], [0.572081, 0.145797, 0.406369], [0.578304, 0.148039, 0.404411], [0.584521, 0.150294, 0.402385], [0.590734, 0.152563, 0.40029], [0.59694, 0.154848, 0.398125], [0.603139, 0.157151, 0.395891], [0.60933, 0.159474, 0.393589], [0.615513, 0.161817, 0.391219], [0.621685, 0.164184, 0.388781], [0.627847, 0.166575, 0.386276], [0.633998, 0.168992, 0.383704], [0.640135, 0.171438, 0.381065], [0.64626, 0.173914, 0.378359], [0.652369, 0.176421, 0.375586], [0.658463, 0.178962, 0.372748], [0.66454, 0.181539, 0.369846], [0.670599, 0.184153, 0.366879], [0.676638, 0.186807, 0.363849], [0.682656, 0.189501, 0.360757], [0.688653, 0.192239, 0.357603], [0.694627, 0.195021, 0.354388], [0.700576, 0.197851, 0.351113], [0.7065, 0.200728, 0.347777], [0.712396, 0.203656, 0.344383], [0.718264, 0.206636, 0.340931], [0.724103, 0.20967, 0.337424], [0.729909, 0.212759, 0.333861], [0.735683, 0.215906, 0.330245], [0.741423, 0.219112, 0.326576], [0.747127, 0.222378, 0.322856], [0.752794, 0.225706, 0.319085], [0.758422, 0.229097, 0.315266], [0.76401, 0.232554, 0.311399], [0.769556, 0.236077, 0.307485], [0.775059, 0.239667, 0.303526], [0.780517, 0.243327, 0.299523], [0.785929, 0.247056, 0.295477], [0.791293, 0.250856, 0.29139], [0.796607, 0.254728, 0.287264], [0.801871, 0.258674, 0.283099], [0.807082, 0.262692, 0.278898], [0.812239, 0.266786, 0.274661], [0.817341, 0.270954, 0.27039], [0.822386, 0.275197, 0.266085], [0.827372, 0.279517, 0.26175], [0.832299, 0.283913, 0.257383], [0.837165, 0.288385, 0.252988], [0.841969, 0.292933, 0.248564], [0.846709, 0.297559, 0.244113], [0.851384, 0.30226, 0.239636], [0.855992, 0.307038, 0.235133], [0.860533, 0.311892, 0.230606], [0.865006, 0.316822, 0.226055], [0.869409, 0.321827, 0.221482], [0.873741, 0.326906, 0.216886], [0.878001, 0.33206, 0.212268], [0.882188, 0.337287, 0.207628], [0.886302, 0.342586, 0.202968], [0.890341, 0.347957, 0.198286], [0.894305, 0.353399, 0.193584], [0.898192, 0.358911, 0.18886], [0.902003, 0.364492, 0.184116], [0.905735, 0.37014, 0.17935], [0.90939, 0.375856, 0.174563], [0.912966, 0.381636, 0.169755], [0.916462, 0.387481, 0.164924], [0.919879, 0.393389, 0.16007], [0.923215, 0.399359, 0.155193], [0.92647, 0.405389, 0.150292], [0.929644, 0.411479, 0.145367], [0.932737, 0.417627, 0.140417], [0.935747, 0.423831, 0.13544], [0.938675, 0.430091, 0.130438], [0.941521, 0.436405, 0.125409], [0.944285, 0.442772, 0.120354], [0.946965, 0.449191, 0.115272], [0.949562, 0.45566, 0.110164], [0.952075, 0.462178, 0.105031], [0.954506, 0.468744, 0.099874], [0.956852, 0.475356, 0.094695], [0.959114, 0.482014, 0.089499], [0.961293, 0.488716, 0.084289], [0.963387, 0.495462, 0.079073], [0.965397, 0.502249, 0.073859], [0.967322, 0.509078, 0.068659], [0.969163, 0.515946, 0.063488], [0.970919, 0.522853, 0.058367], [0.97259, 0.529798, 0.053324], [0.974176, 0.53678, 0.048392], [0.975677, 0.543798, 0.043618], [0.977092, 0.55085, 0.03905], [0.978422, 0.557937, 0.034931], [0.979666, 0.565057, 0.031409], [0.980824, 0.572209, 0.028508], [0.981895, 0.579392, 0.02625], [0.982881, 0.586606, 0.024661], [0.983779, 0.593849, 0.02377], [0.984591, 0.601122, 0.023606], [0.985315, 0.608422, 0.024202], [0.985952, 0.61575, 0.025592], [0.986502, 0.623105, 0.027814], [0.986964, 0.630485, 0.030908], [0.987337, 0.63789, 0.034916], [0.987622, 0.64532, 0.039886], [0.987819, 0.652773, 0.045581], [0.987926, 0.66025, 0.05175], [0.987945, 0.667748, 0.058329], [0.987874, 0.675267, 0.065257], [0.987714, 0.682807, 0.072489], [0.987464, 0.690366, 0.07999], [0.987124, 0.697944, 0.087731], [0.986694, 0.70554, 0.095694], [0.986175, 0.713153, 0.103863], [0.985566, 0.720782, 0.112229], [0.984865, 0.728427, 0.120785], [0.984075, 0.736087, 0.129527], [0.983196, 0.743758, 0.138453], [0.982228, 0.751442, 0.147565], [0.981173, 0.759135, 0.156863], [0.980032, 0.766837, 0.166353], [0.978806, 0.774545, 0.176037], [0.977497, 0.782258, 0.185923], [0.976108, 0.789974, 0.196018], [0.974638, 0.797692, 0.206332], [0.973088, 0.805409, 0.216877], [0.971468, 0.813122, 0.227658], [0.969783, 0.820825, 0.238686], [0.968041, 0.828515, 0.249972], [0.966243, 0.836191, 0.261534], [0.964394, 0.843848, 0.273391], [0.962517, 0.851476, 0.285546], [0.960626, 0.859069, 0.29801], [0.95872, 0.866624, 0.31082], [0.956834, 0.874129, 0.323974], [0.954997, 0.881569, 0.337475], [0.953215, 0.888942, 0.351369], [0.951546, 0.896226, 0.365627], [0.950018, 0.903409, 0.380271], [0.948683, 0.910473, 0.395289], [0.947594, 0.917399, 0.410665], [0.946809, 0.924168, 0.426373], [0.946392, 0.930761, 0.442367], [0.946403, 0.937159, 0.458592], [0.946903, 0.943348, 0.47497], [0.947937, 0.949318, 0.491426], [0.949545, 0.955063, 0.50786], [0.95174, 0.960587, 0.524203], [0.954529, 0.965896, 0.540361], [0.957896, 0.971003, 0.556275], [0.961812, 0.975924, 0.571925], [0.966249, 0.980678, 0.587206], [0.971162, 0.985282, 0.602154], [0.976511, 0.989753, 0.61676], [0.982257, 0.994109, 0.631017], [0.988362, 0.998364, 0.644924]];
const siesmiccmap = [[0.0, 0.0, 0.3], [0.0, 0.0, 0.31098039215686274], [0.0, 0.0, 0.3219607843137255], [0.0, 0.0, 0.33294117647058824], [0.0, 0.0, 0.34392156862745094], [0.0, 0.0, 0.3549019607843137], [0.0, 0.0, 0.36588235294117644], [0.0, 0.0, 0.3768627450980392], [0.0, 0.0, 0.38784313725490194], [0.0, 0.0, 0.3988235294117647], [0.0, 0.0, 0.40980392156862744], [0.0, 0.0, 0.4207843137254902], [0.0, 0.0, 0.43176470588235294], [0.0, 0.0, 0.4427450980392157], [0.0, 0.0, 0.45372549019607844], [0.0, 0.0, 0.4647058823529412], [0.0, 0.0, 0.4756862745098039], [0.0, 0.0, 0.48666666666666664], [0.0, 0.0, 0.4976470588235294], [0.0, 0.0, 0.5086274509803921], [0.0, 0.0, 0.5196078431372548], [0.0, 0.0, 0.5305882352941176], [0.0, 0.0, 0.5415686274509803], [0.0, 0.0, 0.5525490196078431], [0.0, 0.0, 0.5635294117647058], [0.0, 0.0, 0.5745098039215686], [0.0, 0.0, 0.5854901960784313], [0.0, 0.0, 0.5964705882352941], [0.0, 0.0, 0.6074509803921568], [0.0, 0.0, 0.6184313725490196], [0.0, 0.0, 0.6294117647058823], [0.0, 0.0, 0.6403921568627451], [0.0, 0.0, 0.6513725490196078], [0.0, 0.0, 0.6623529411764706], [0.0, 0.0, 0.6733333333333333], [0.0, 0.0, 0.6843137254901961], [0.0, 0.0, 0.6952941176470588], [0.0, 0.0, 0.7062745098039215], [0.0, 0.0, 0.7172549019607843], [0.0, 0.0, 0.7282352941176471], [0.0, 0.0, 0.7392156862745097], [0.0, 0.0, 0.7501960784313725], [0.0, 0.0, 0.7611764705882352], [0.0, 0.0, 0.7721568627450981], [0.0, 0.0, 0.7831372549019607], [0.0, 0.0, 0.7941176470588234], [0.0, 0.0, 0.8050980392156861], [0.0, 0.0, 0.8160784313725491], [0.0, 0.0, 0.8270588235294116], [0.0, 0.0, 0.8380392156862744], [0.0, 0.0, 0.8490196078431371], [0.0, 0.0, 0.8599999999999999], [0.0, 0.0, 0.8709803921568626], [0.0, 0.0, 0.8819607843137254], [0.0, 0.0, 0.8929411764705881], [0.0, 0.0, 0.9039215686274509], [0.0, 0.0, 0.9149019607843136], [0.0, 0.0, 0.9258823529411764], [0.0, 0.0, 0.9368627450980391], [0.0, 0.0, 0.9478431372549019], [0.0, 0.0, 0.9588235294117646], [0.0, 0.0, 0.9698039215686274], [0.0, 0.0, 0.9807843137254901], [0.0, 0.0, 0.9917647058823529], [0.00392156862745098, 0.00392156862745098, 1.0], [0.0196078431372549, 0.0196078431372549, 1.0], [0.0352941176470586, 0.0352941176470586, 1.0], [0.050980392156862744, 0.050980392156862744, 1.0], [0.06666666666666667, 0.06666666666666667, 1.0], [0.08235294117647059, 0.08235294117647059, 1.0], [0.09803921568627451, 0.09803921568627451, 1.0], [0.11372549019607843, 0.11372549019607843, 1.0], [0.12941176470588237, 0.12941176470588237, 1.0], [0.1450980392156863, 0.1450980392156863, 1.0], [0.16078431372548999, 0.16078431372548999, 1.0], [0.17647058823529413, 0.17647058823529413, 1.0], [0.19215686274509805, 0.19215686274509805, 1.0], [0.20784313725490197, 0.20784313725490197, 1.0], [0.2235294117647059, 0.2235294117647059, 1.0], [0.23921568627450981, 0.23921568627450981, 1.0], [0.2549019607843137, 0.2549019607843137, 1.0], [0.27058823529411763, 0.27058823529411763, 1.0], [0.28627450980392133, 0.28627450980392133, 1.0], [0.30196078431372547, 0.30196078431372547, 1.0], [0.3176470588235294, 0.3176470588235294, 1.0], [0.3333333333333333, 0.3333333333333333, 1.0], [0.34901960784313724, 0.34901960784313724, 1.0], [0.36470588235294116, 0.36470588235294116, 1.0], [0.3803921568627451, 0.3803921568627451, 1.0], [0.396078431372549, 0.396078431372549, 1.0], [0.4117647058823527, 0.4117647058823527, 1.0], [0.42745098039215684, 0.42745098039215684, 1.0], [0.44313725490196076, 0.44313725490196076, 1.0], [0.4588235294117647, 0.4588235294117647, 1.0], [0.4745098039215686, 0.4745098039215686, 1.0], [0.49019607843137253, 0.49019607843137253, 1.0], [0.5058823529411764, 0.5058823529411764, 1.0], [0.5215686274509804, 0.5215686274509804, 1.0], [0.5372549019607841, 0.5372549019607841, 1.0], [0.5529411764705883, 0.5529411764705883, 1.0], [0.5686274509803921, 0.5686274509803921, 1.0], [0.5843137254901961, 0.5843137254901961, 1.0], [0.6, 0.6, 1.0], [0.615686274509804, 0.615686274509804, 1.0], [0.6313725490196078, 0.6313725490196078, 1.0], [0.6470588235294118, 0.6470588235294118, 1.0], [0.6627450980392154, 0.6627450980392154, 1.0], [0.6784313725490196, 0.6784313725490196, 1.0], [0.6941176470588235, 0.6941176470588235, 1.0], [0.7098039215686275, 0.7098039215686275, 1.0], [0.7254901960784313, 0.7254901960784313, 1.0], [0.7411764705882353, 0.7411764705882353, 1.0], [0.7568627450980392, 0.7568627450980392, 1.0], [0.7725490196078432, 0.7725490196078432, 1.0], [0.7882352941176468, 0.7882352941176468, 1.0], [0.803921568627451, 0.803921568627451, 1.0], [0.8196078431372549, 0.8196078431372549, 1.0], [0.8352941176470589, 0.8352941176470589, 1.0], [0.8509803921568627, 0.8509803921568627, 1.0], [0.8666666666666667, 0.8666666666666667, 1.0], [0.8823529411764706, 0.8823529411764706, 1.0], [0.8980392156862745, 0.8980392156862745, 1.0], [0.9137254901960782, 0.9137254901960782, 1.0], [0.9294117647058824, 0.9294117647058824, 1.0], [0.9450980392156862, 0.9450980392156862, 1.0], [0.9607843137254902, 0.9607843137254902, 1.0], [0.9764705882352941, 0.9764705882352941, 1.0], [0.9921568627450981, 0.9921568627450981, 1.0], [1.0, 0.9921568627450981, 0.9921568627450981], [1.0, 0.9764705882352941, 0.9764705882352941], [1.0, 0.9607843137254902, 0.9607843137254902], [1.0, 0.9450980392156862, 0.9450980392156862], [1.0, 0.9294117647058828, 0.9294117647058828], [1.0, 0.9137254901960784, 0.9137254901960784], [1.0, 0.8980392156862745, 0.8980392156862745], [1.0, 0.8823529411764706, 0.8823529411764706], [1.0, 0.8666666666666667, 0.8666666666666667], [1.0, 0.8509803921568627, 0.8509803921568627], [1.0, 0.8352941176470589, 0.8352941176470589], [1.0, 0.8196078431372549, 0.8196078431372549], [1.0, 0.803921568627451, 0.803921568627451], [1.0, 0.788235294117647, 0.788235294117647], [1.0, 0.7725490196078432, 0.7725490196078432], [1.0, 0.7568627450980392, 0.7568627450980392], [1.0, 0.7411764705882353, 0.7411764705882353], [1.0, 0.7254901960784313, 0.7254901960784313], [1.0, 0.7098039215686274, 0.7098039215686274], [1.0, 0.6941176470588235, 0.6941176470588235], [1.0, 0.6784313725490201, 0.6784313725490201], [1.0, 0.6627450980392157, 0.6627450980392157], [1.0, 0.6470588235294117, 0.6470588235294117], [1.0, 0.6313725490196078, 0.6313725490196078], [1.0, 0.615686274509804, 0.615686274509804], [1.0, 0.6, 0.6], [1.0, 0.584313725490196, 0.584313725490196], [1.0, 0.5686274509803921, 0.5686274509803921], [1.0, 0.5529411764705883, 0.5529411764705883], [1.0, 0.5372549019607843, 0.5372549019607843], [1.0, 0.5215686274509803, 0.5215686274509803], [1.0, 0.5058823529411764, 0.5058823529411764], [1.0, 0.4901960784313726, 0.4901960784313726], [1.0, 0.4745098039215686, 0.4745098039215686], [1.0, 0.45882352941176474, 0.45882352941176474], [1.0, 0.44313725490196076, 0.44313725490196076], [1.0, 0.42745098039215734, 0.42745098039215734], [1.0, 0.4117647058823529, 0.4117647058823529], [1.0, 0.39607843137254906, 0.39607843137254906], [1.0, 0.3803921568627451, 0.3803921568627451], [1.0, 0.3647058823529412, 0.3647058823529412], [1.0, 0.34901960784313724, 0.34901960784313724], [1.0, 0.33333333333333337, 0.33333333333333337], [1.0, 0.3176470588235294, 0.3176470588235294], [1.0, 0.3019607843137255, 0.3019607843137255], [1.0, 0.28627450980392155, 0.28627450980392155], [1.0, 0.2705882352941177, 0.2705882352941177], [1.0, 0.2549019607843137, 0.2549019607843137], [1.0, 0.23921568627450984, 0.23921568627450984], [1.0, 0.22352941176470587, 0.22352941176470587], [1.0, 0.207843137254902, 0.207843137254902], [1.0, 0.19215686274509802, 0.19215686274509802], [1.0, 0.1764705882352946, 0.1764705882352946], [1.0, 0.16078431372549018, 0.16078431372549018], [1.0, 0.14509803921568631, 0.14509803921568631], [1.0, 0.12941176470588234, 0.12941176470588234], [1.0, 0.11372549019607847, 0.11372549019607847], [1.0, 0.0980392156862745, 0.0980392156862745], [1.0, 0.08235294117647063, 0.08235294117647063], [1.0, 0.06666666666666665, 0.06666666666666665], [1.0, 0.050980392156862786, 0.050980392156862786], [1.0, 0.03529411764705881, 0.03529411764705881], [1.0, 0.019607843137254943, 0.019607843137254943], [1.0, 0.0039215686274509665, 0.0039215686274509665], [0.9941176470588236, 0.0, 0.0], [0.9862745098039216, 0.0, 0.0], [0.9784313725490196, 0.0, 0.0], [0.9705882352941176, 0.0, 0.0], [0.9627450980392159, 0.0, 0.0], [0.9549019607843138, 0.0, 0.0], [0.9470588235294117, 0.0, 0.0], [0.9392156862745098, 0.0, 0.0], [0.9313725490196079, 0.0, 0.0], [0.9235294117647059, 0.0, 0.0], [0.9156862745098039, 0.0, 0.0], [0.907843137254902, 0.0, 0.0], [0.9, 0.0, 0.0], [0.892156862745098, 0.0, 0.0], [0.884313725490196, 0.0, 0.0], [0.8764705882352941, 0.0, 0.0], [0.8686274509803922, 0.0, 0.0], [0.8607843137254902, 0.0, 0.0], [0.8529411764705882, 0.0, 0.0], [0.8450980392156863, 0.0, 0.0], [0.8372549019607846, 0.0, 0.0], [0.8294117647058823, 0.0, 0.0], [0.8215686274509804, 0.0, 0.0], [0.8137254901960784, 0.0, 0.0], [0.8058823529411765, 0.0, 0.0], [0.7980392156862746, 0.0, 0.0], [0.7901960784313725, 0.0, 0.0], [0.7823529411764706, 0.0, 0.0], [0.7745098039215687, 0.0, 0.0], [0.7666666666666666, 0.0, 0.0], [0.7588235294117647, 0.0, 0.0], [0.7509803921568627, 0.0, 0.0], [0.7431372549019608, 0.0, 0.0], [0.7352941176470589, 0.0, 0.0], [0.7274509803921569, 0.0, 0.0], [0.7196078431372549, 0.0, 0.0], [0.7117647058823532, 0.0, 0.0], [0.7039215686274509, 0.0, 0.0], [0.696078431372549, 0.0, 0.0], [0.6882352941176471, 0.0, 0.0], [0.6803921568627451, 0.0, 0.0], [0.6725490196078432, 0.0, 0.0], [0.6647058823529413, 0.0, 0.0], [0.6568627450980392, 0.0, 0.0], [0.6490196078431373, 0.0, 0.0], [0.6411764705882352, 0.0, 0.0], [0.6333333333333333, 0.0, 0.0], [0.6254901960784314, 0.0, 0.0], [0.6176470588235294, 0.0, 0.0], [0.6098039215686275, 0.0, 0.0], [0.6019607843137256, 0.0, 0.0], [0.5941176470588235, 0.0, 0.0], [0.5862745098039218, 0.0, 0.0], [0.5784313725490196, 0.0, 0.0], [0.5705882352941176, 0.0, 0.0], [0.5627450980392157, 0.0, 0.0], [0.5549019607843138, 0.0, 0.0], [0.5470588235294118, 0.0, 0.0], [0.5392156862745099, 0.0, 0.0], [0.5313725490196078, 0.0, 0.0], [0.5235294117647059, 0.0, 0.0], [0.5156862745098039, 0.0, 0.0], [0.5078431372549019, 0.0, 0.0], [0.5, 0.0, 0.0]];
const RdYlBucmap = [[0.6470588235294118, 0.0, 0.14901960784313725], [0.6547481737793157, 0.007381776239907728, 0.14917339484813533], [0.6624375240292195, 0.014763552479815456, 0.1493271818531334], [0.6701268742791234, 0.022145328719723183, 0.14948096885813147], [0.6778162245290273, 0.02952710495963091, 0.14963475586312958], [0.6855055747789311, 0.03690888119953864, 0.14978854286812765], [0.6931949250288351, 0.044290657439446365, 0.14994232987312572], [0.700884275278739, 0.0516724336793541, 0.1500961168781238], [0.7085736255286429, 0.05905420991926182, 0.15024990388312187], [0.7162629757785467, 0.06643598615916955, 0.15040369088811995], [0.7239523260284506, 0.07381776239907728, 0.15055747789311805], [0.7316416762783545, 0.081199538638985, 0.15071126489811612], [0.7393310265282584, 0.08858131487889273, 0.1508650519031142], [0.7470203767781622, 0.09596309111880046, 0.15101883890811227], [0.7547097270280662, 0.1033448673587082, 0.15117262591311034], [0.7623990772779701, 0.11072664359861592, 0.15132641291810842], [0.7700884275278739, 0.11810841983852365, 0.15148019992310652], [0.7777777777777778, 0.12549019607843137, 0.1516339869281046], [0.7854671280276817, 0.1328719723183391, 0.15178777393310267], [0.7931564782775855, 0.14025374855824682, 0.15194156093810074], [0.8008458285274894, 0.14763552479815456, 0.1520953479430988], [0.8085351787773933, 0.15501730103806227, 0.1522491349480969], [0.8162245290272971, 0.16239907727797, 0.15240292195309496], [0.8239138792772011, 0.16978085351787775, 0.15255670895809306], [0.831603229527105, 0.17716262975778546, 0.15271049596309114], [0.8392925797770088, 0.18454440599769317, 0.1528642829680892], [0.8453671664744329, 0.19292579777008842, 0.15509419454056134], [0.8498269896193772, 0.20230680507497117, 0.15940023068050752], [0.8542868127643214, 0.2116878123798539, 0.1637062668204537], [0.8587466359092657, 0.22106881968473663, 0.16801230296039987], [0.8632064590542099, 0.23044982698961938, 0.17231833910034602], [0.8676662821991542, 0.2398308342945021, 0.1766243752402922], [0.8721261053440984, 0.24921184159938484, 0.18093041138023838], [0.8765859284890427, 0.25859284890426754, 0.18523644752018453], [0.8810457516339869, 0.2679738562091503, 0.1895424836601307], [0.8855055747789312, 0.27735486351403305, 0.1938485198000769], [0.8899653979238754, 0.2867358708189158, 0.19815455594002307], [0.8944252210688197, 0.29611687812379844, 0.20246059207996922], [0.8988850442137639, 0.3054978854286813, 0.20676662821991543], [0.9033448673587082, 0.314878892733564, 0.2110726643598616], [0.9078046905036524, 0.32425990003844674, 0.21537870049980778], [0.9122645136485967, 0.3336409073433294, 0.2196847366397539], [0.9167243367935409, 0.3430219146482122, 0.22399077277970014], [0.9211841599384852, 0.35240292195309497, 0.22829680891964632], [0.9256439830834294, 0.36178392925797764, 0.23260284505959247], [0.9301038062283737, 0.37116493656286037, 0.23690888119953862], [0.9345636293733179, 0.38054594386774315, 0.24121491733948483], [0.9390234525182622, 0.3899269511726259, 0.24552095347943098], [0.9434832756632066, 0.39930795847750866, 0.24982698961937716], [0.9479430988081508, 0.40868896578239133, 0.2541330257593233], [0.952402921953095, 0.4180699730872741, 0.2584390618992695], [0.9568627450980393, 0.42745098039215684, 0.2627450980392157], [0.958246828143022, 0.43744713571703187, 0.267358708189158], [0.9596309111880047, 0.44744329104190683, 0.2719723183391003], [0.9610149942329873, 0.45743944636678197, 0.2765859284890427], [0.96239907727797, 0.46743560169165704, 0.281199538638985], [0.9637831603229527, 0.47743175701653207, 0.28581314878892733], [0.9651672433679355, 0.48742791234140703, 0.2904267589388696], [0.9665513264129182, 0.49742406766628217, 0.295040369088812], [0.9679354094579008, 0.5074202229911572, 0.2996539792387543], [0.9693194925028835, 0.5174163783160323, 0.30426758938869664], [0.9707035755478662, 0.5274125336409072, 0.3088811995386389], [0.972087658592849, 0.5374086889657823, 0.3134948096885813], [0.9734717416378317, 0.5474048442906574, 0.3181084198385236], [0.9748558246828143, 0.5574009996155325, 0.32272202998846594], [0.976239907727797, 0.5673971549404074, 0.32733564013840827], [0.9776239907727797, 0.5773933102652824, 0.33194925028835054], [0.9790080738177624, 0.5873894655901576, 0.3365628604382929], [0.9803921568627452, 0.5973856209150326, 0.34117647058823525], [0.9817762399077278, 0.6073817762399076, 0.3457900807381776], [0.9831603229527105, 0.6173779315647827, 0.3504036908881199], [0.9845444059976932, 0.6273740868896577, 0.3550173010380622], [0.9859284890426759, 0.6373702422145328, 0.35963091118800455], [0.9873125720876587, 0.6473663975394078, 0.3642445213379469], [0.9886966551326413, 0.6573625528642827, 0.36885813148788915], [0.990080738177624, 0.6673587081891579, 0.37347174163783153], [0.9914648212226067, 0.677354863514033, 0.37808535178777386], [0.9922337562475971, 0.6861976163014224, 0.3840061514801998], [0.9923875432525952, 0.6938869665513263, 0.3912341407151095], [0.9925413302575933, 0.7015763168012302, 0.3984621299500191], [0.9926951172625913, 0.7092656670511341, 0.40569011918492875], [0.9928489042675894, 0.716955017301038, 0.41291810841983845], [0.9930026912725874, 0.7246443675509417, 0.420146097654748], [0.9931564782775856, 0.7323337178008458, 0.4273740868896577], [0.9933102652825836, 0.7400230680507497, 0.43460207612456736], [0.9934640522875817, 0.7477124183006535, 0.44183006535947705], [0.9936178392925799, 0.7554017685505574, 0.4490580545943867], [0.9937716262975779, 0.7630911188004613, 0.45628604382929633], [0.993925413302576, 0.7707804690503652, 0.463514033064206], [0.994079200307574, 0.778469819300269, 0.47074202229911566], [0.9942329873125721, 0.7861591695501728, 0.4779700115340252], [0.9943867743175702, 0.7938485198000769, 0.48519800076893493], [0.9945405613225683, 0.8015378700499807, 0.4924259900038446], [0.9946943483275663, 0.8092272202998846, 0.49965397923875426], [0.9948481353325644, 0.8169165705497885, 0.506881968473664], [0.9950019223375625, 0.8246059207996924, 0.5141099577085736], [0.9951557093425606, 0.8322952710495963, 0.5213379469434832], [0.9953094963475586, 0.8399846212995001, 0.5285659361783929], [0.9954632833525567, 0.8476739715494039, 0.5357939254133024], [0.9956170703575548, 0.855363321799308, 0.5430219146482123], [0.9957708573625529, 0.8630526720492118, 0.5502499038831219], [0.9959246443675509, 0.8707420222991157, 0.5574778931180315], [0.996078431372549, 0.8784313725490196, 0.5647058823529412], [0.9962322183775472, 0.88319876970396, 0.5719338715878508], [0.9963860053825452, 0.8879661668589004, 0.5791618608227604], [0.9965397923875433, 0.8927335640138409, 0.5863898500576701], [0.9966935793925413, 0.8975009611687812, 0.5936178392925797], [0.9968473663975395, 0.9022683583237217, 0.6008458285274895], [0.9970011534025375, 0.907035755478662, 0.6080738177623991], [0.9971549404075356, 0.9118031526336025, 0.6153018069973087], [0.9973087274125336, 0.9165705497885429, 0.6225297962322184], [0.9974625144175318, 0.9213379469434833, 0.629757785467128], [0.9976163014225298, 0.9261053440984237, 0.6369857747020377], [0.9977700884275279, 0.930872741253364, 0.6442137639369473], [0.9979238754325259, 0.9356401384083044, 0.6514417531718568], [0.998077662437524, 0.9404075355632449, 0.6586697424067667], [0.9982314494425221, 0.9451749327181853, 0.6658977316416763], [0.9983852364475202, 0.9499423298731258, 0.673125720876586], [0.9985390234525182, 0.9547097270280661, 0.6803537101114956], [0.9986928104575163, 0.9594771241830066, 0.6875816993464052], [0.9988465974625145, 0.9642445213379469, 0.6948096885813149], [0.9990003844675125, 0.9690119184928874, 0.7020376778162245], [0.9991541714725106, 0.9737793156478277, 0.7092656670511341], [0.9993079584775086, 0.9785467128027682, 0.7164936562860438], [0.9994617454825068, 0.9833141099577085, 0.7237216455209535], [0.9996155324875048, 0.988081507112649, 0.7309496347558632], [0.9997693194925029, 0.9928489042675894, 0.7381776239907728], [0.9999231064975009, 0.9976163014225298, 0.7454056132256824], [0.9976163014225298, 0.9990772779700116, 0.7534025374855825], [0.9928489042675894, 0.9972318339100346, 0.7621683967704729], [0.988081507112649, 0.9953863898500577, 0.7709342560553633], [0.9833141099577086, 0.9935409457900808, 0.7797001153402537], [0.9785467128027683, 0.9916955017301039, 0.7884659746251439], [0.9737793156478278, 0.9898500576701269, 0.7972318339100346], [0.9690119184928874, 0.9880046136101499, 0.805997693194925], [0.964244521337947, 0.986159169550173, 0.8147635524798154], [0.9594771241830066, 0.984313725490196, 0.8235294117647058], [0.9547097270280662, 0.9824682814302191, 0.8322952710495962], [0.9499423298731258, 0.9806228373702423, 0.8410611303344866], [0.9451749327181853, 0.9787773933102653, 0.8498269896193771], [0.940407535563245, 0.9769319492502884, 0.8585928489042675], [0.9356401384083045, 0.9750865051903114, 0.8673587081891578], [0.9308727412533642, 0.9732410611303345, 0.8761245674740483], [0.9261053440984237, 0.9713956170703576, 0.8848904267589387], [0.9213379469434834, 0.9695501730103806, 0.8936562860438291], [0.9165705497885429, 0.9677047289504037, 0.9024221453287196], [0.9118031526336026, 0.9658592848904267, 0.9111880046136099], [0.9070357554786621, 0.9640138408304498, 0.9199538638985003], [0.9022683583237219, 0.962168396770473, 0.9287197231833906], [0.8975009611687813, 0.960322952710496, 0.9374855824682813], [0.892733564013841, 0.9584775086505191, 0.9462514417531716], [0.8879661668589005, 0.9566320645905421, 0.955017301038062], [0.8831987697039602, 0.9547866205305652, 0.9637831603229524], [0.8784313725490197, 0.9529411764705882, 0.9725490196078429], [0.8702806612841217, 0.9489427143406383, 0.9702422145328721], [0.8621299500192235, 0.9449442522106882, 0.9679354094579009], [0.8539792387543255, 0.9409457900807382, 0.9656286043829297], [0.8458285274894274, 0.9369473279507883, 0.9633217993079586], [0.8376778162245292, 0.9329488658208382, 0.9610149942329873], [0.8295271049596311, 0.9289504036908882, 0.9587081891580161], [0.821376393694733, 0.9249519415609382, 0.956401384083045], [0.8132256824298348, 0.9209534794309882, 0.9540945790080738], [0.8050749711649368, 0.9169550173010381, 0.9517877739331027], [0.7969242599000387, 0.9129565551710881, 0.9494809688581315], [0.7887735486351408, 0.9089580930411382, 0.9471741637831604], [0.7806228373702424, 0.904959630911188, 0.9448673587081892], [0.7724721261053443, 0.9009611687812381, 0.942560553633218], [0.7643214148404461, 0.8969627066512881, 0.9402537485582468], [0.756170703575548, 0.892964244521338, 0.9379469434832757], [0.74801999231065, 0.888965782391388, 0.9356401384083045], [0.7398692810457519, 0.884967320261438, 0.9333333333333333], [0.7317185697808537, 0.880968858131488, 0.9310265282583622], [0.7235678585159556, 0.8769703960015379, 0.928719723183391], [0.7154171472510575, 0.8729719338715879, 0.9264129181084199], [0.7072664359861593, 0.868973471741638, 0.9241061130334487], [0.6991157247212613, 0.8649750096116879, 0.9217993079584775], [0.6909650134563632, 0.8609765474817379, 0.9194925028835064], [0.682814302191465, 0.8569780853517879, 0.9171856978085352], [0.6746635909265669, 0.8529796232218378, 0.914878892733564], [0.6663590926566707, 0.8475970780469052, 0.9118800461361016], [0.6579008073817767, 0.84083044982699, 0.9081891580161479], [0.6494425221068821, 0.8340638216070744, 0.9044982698961939], [0.6409842368319879, 0.8272971933871589, 0.90080738177624], [0.6325259515570936, 0.8205305651672435, 0.8971164936562861], [0.6240676662821993, 0.8137639369473281, 0.8934256055363322], [0.615609381007305, 0.8069973087274127, 0.8897347174163783], [0.6071510957324108, 0.8002306805074972, 0.8860438292964244], [0.5986928104575164, 0.7934640522875818, 0.8823529411764707], [0.5902345251826222, 0.7866974240676664, 0.8786620530565168], [0.5817762399077279, 0.7799307958477509, 0.8749711649365629], [0.5733179546328336, 0.7731641676278356, 0.871280276816609], [0.5648596693579393, 0.7663975394079201, 0.8675893886966551], [0.5564013840830451, 0.7596309111880047, 0.8638985005767013], [0.5479430988081508, 0.7528642829680893, 0.8602076124567474], [0.5394848135332565, 0.7460976547481739, 0.8565167243367936], [0.5310265282583623, 0.7393310265282584, 0.8528258362168397], [0.5225682429834682, 0.7325643983083432, 0.8491349480968859], [0.5141099577085737, 0.7257977700884276, 0.845444059976932], [0.5056516724336794, 0.7190311418685121, 0.8417531718569781], [0.49719338715878514, 0.7122645136485968, 0.8380622837370242], [0.48873510188389085, 0.7054978854286813, 0.8343713956170704], [0.48027681660899657, 0.6987312572087659, 0.8306805074971165], [0.47181853133410223, 0.6919646289888505, 0.8269896193771626], [0.463360246059208, 0.6851980007689351, 0.8232987312572088], [0.4549019607843137, 0.6784313725490196, 0.8196078431372549], [0.4476739715494041, 0.6698193002691273, 0.8151480199923107], [0.44044598231449444, 0.6612072279892349, 0.8106881968473664], [0.43321799307958475, 0.6525951557093426, 0.8062283737024222], [0.4259900038446751, 0.6439830834294502, 0.8017685505574779], [0.4187620146097655, 0.6353710111495579, 0.7973087274125337], [0.41153402537485584, 0.6267589388696655, 0.7928489042675894], [0.40430603613994615, 0.6181468665897731, 0.7883890811226452], [0.39707804690503673, 0.6095347943098811, 0.783929257977701], [0.38985005767012687, 0.6009227220299884, 0.7794694348327567], [0.38262206843521723, 0.5923106497500962, 0.7750096116878123], [0.37539407920030754, 0.5836985774702038, 0.7705497885428682], [0.3681660899653979, 0.5750865051903115, 0.7660899653979238], [0.36093810073048826, 0.5664744329104191, 0.7616301422529796], [0.3537101114955786, 0.5578623606305267, 0.7571703191080353], [0.346482122260669, 0.5492502883506344, 0.7527104959630911], [0.3392541330257593, 0.540638216070742, 0.7482506728181468], [0.33202614379084966, 0.5320261437908497, 0.7437908496732026], [0.32479815455593997, 0.5234140715109573, 0.7393310265282584], [0.31757016532103033, 0.514801999231065, 0.7348712033833141], [0.3103421760861207, 0.5061899269511726, 0.7304113802383699], [0.30311418685121105, 0.49757785467128024, 0.7259515570934256], [0.2958861976163014, 0.4889657823913879, 0.7214917339484814], [0.2886582083813918, 0.4803537101114955, 0.7170319108035371], [0.2814302191464823, 0.4717416378316035, 0.712572087658593], [0.2742022299115725, 0.46312956555171086, 0.7081122645136486], [0.26905036524413684, 0.4539792387543252, 0.7034986543637063], [0.2659746251441753, 0.44429065743944635, 0.6987312572087659], [0.26289888504421377, 0.43460207612456747, 0.6939638600538255], [0.2598231449442522, 0.42491349480968854, 0.6891964628988851], [0.25674740484429065, 0.41522491349480967, 0.6844290657439447], [0.2536716647443291, 0.4055363321799308, 0.6796616685890042], [0.25059592464436753, 0.39584775086505186, 0.6748942714340639], [0.247520184544406, 0.386159169550173, 0.6701268742791234], [0.24444444444444444, 0.3764705882352941, 0.6653594771241831], [0.24136870434448288, 0.3667820069204152, 0.6605920799692426], [0.23829296424452134, 0.3570934256055363, 0.6558246828143023], [0.23521722414455978, 0.34740484429065743, 0.6510572856593618], [0.23214148404459822, 0.33771626297577856, 0.6462898885044214], [0.2290657439446367, 0.32802768166089963, 0.641522491349481], [0.2259900038446752, 0.31833910034602103, 0.6367550941945408], [0.22291426374471357, 0.3086505190311419, 0.6319876970396002], [0.219838523644752, 0.29896193771626295, 0.6272202998846598], [0.21676278354479048, 0.2892733564013841, 0.6224529027297194], [0.21368704344482892, 0.2795847750865052, 0.617685505574779], [0.21061130334486738, 0.2698961937716263, 0.6129181084198385], [0.2075355632449058, 0.2602076124567474, 0.6081507112648982], [0.20445982314494426, 0.25051903114186846, 0.6033833141099577], [0.2013840830449827, 0.24083044982698962, 0.5986159169550174], [0.19830834294502114, 0.23114186851211074, 0.5938485198000769], [0.1952326028450596, 0.2214532871972318, 0.5890811226451365], [0.19215686274509805, 0.21176470588235294, 0.5843137254901961]];
const graymap = Array.from({ length: 256 }, (_, i) => { const val = i / 255; return [val, val, val]; }); // RGB iguales = escala de grises 
const constant = Array.from({ length: 256 }, () => [0.533, 0.533, 0.533]); // Valor constante = 0x888888 en RGB = 136 / 255

const colors255 = { 
    'constant': constant,
    'graymap': graymap,
    'jetcmap': jetcmap,
    'viridiscmap': viridiscmap,
    'infernocmap': infernocmap,
    'seismiccmap': siesmiccmap,
    'RdYlBucmap': RdYlBucmap
};

function applyColormap(imageData, colormapId) {
    let output;
    const width = imageData.width;
    const height = imageData.height;
    const input = imageData.data;

    // Primero, se guardan los valores a y b del espacio Lab de cada pxel de la imagen original. 
    // Luego, se crea un colormap especial en RGB usando esos valores a y b combinados con el valor L 
    // actual (altura del mesh) para aproximar el color de textura en la zona correspondiente del pxel en la malla.
    // Nota: Esto es as porque, sea cual sea el tipo de imagen de entrada, las PDE se resuelven con el canal de luminancia.
    // Resto de colormaps ms "normales"
    const colormap = colors255[colormapId];
    output = new Uint8ClampedArray(width * height * 4);

    for (let i = 0; i < width * height; i++) {
        const inputIndex = i * 4;
        const outputIndex = i * 4;
        
        // Valor de gris (todos los canales son iguales)
        const grayValue = input[inputIndex];
        const color = colormap[grayValue];
        
        output[outputIndex] = Math.round(color[0] * 255);     // R
        output[outputIndex + 1] = Math.round(color[1] * 255); // G
        output[outputIndex + 2] = Math.round(color[2] * 255); // B
        output[outputIndex + 3] = 255;                        // Alpha
    }

    return new ImageData(output, width, height);
}

function applyOriginalLabColormapToImage(imageData, aData, bData, origWidth, origHeight) {
    const w = imageData.width;
    const h = imageData.height;
    const output = new ImageData(w, h);
    
    for (let j = 0; j < h; j++) {
        for (let i = 0; i < w; i++) {
            const index = j * w + i;
            const dataIndex = index * 4;
            
            const heightValue = imageData.data[dataIndex]; // [0.0, 255.0]
            
            // Calcular posicin relativa en la imagen original, de tamao originalWidthxoriginalHeight
            const relX = i / (w - 1);
            const relY = j / (h - 1);
            
            // Mapear a coordenadas de la imagen original
            const origX = Math.floor(relX * (origWidth - 1));
            const origY = Math.floor(relY * (origHeight - 1));
            const origIndex = origY * origWidth + origX;
            
            // Obtener valores Lab
            const L_val = heightValue * 100 / 255; // [0.0, 255.0] -> [0, 100]
            const a_val = aData ? aData[origIndex] : 0;
            const b_val = bData ? bData[origIndex] : 0;
            
            // Convertir Lab a RGB
            const [r, g, b] = labToRgb(L_val, a_val, b_val);
            
            // Asignar valores RGB
            output.data[dataIndex] = r * 255;
            output.data[dataIndex + 1] = g * 255;
            output.data[dataIndex + 2] = b * 255;
            output.data[dataIndex + 3] = 255;
        }
    }
    
    return output;
}

function applyOriginalLabColormapToImageFullRes(heightMapFlat, aData, bData, origWidth, origHeight, meshWidth, meshHeight) {
    const output = new ImageData(origWidth, origHeight);
    
    for (let j = 0; j < origHeight; j++) {
        for (let i = 0; i < origWidth; i++) {
            const index = j * origWidth + i;
            const dataIndex = index * 4;
            
            // Mapear coordenadas originales a la malla
            const meshX = Math.floor((i / (origWidth - 1)) * (meshWidth - 1));
            const meshY = Math.floor((j / (origHeight - 1)) * (meshHeight - 1));
            const meshIndex = meshY * meshWidth + meshX;
            
            // Obtener altura de la malla
            const heightValue = heightMapFlat[meshIndex];
            const L_val = heightValue * 100; // [0,100]
            
            // Usar ab originales
            const a_val = aData ? aData[index] : 0;
            const b_val = bData ? bData[index] : 0;
            
            // Convertir Lab a RGB
            const [r, g, b] = labToRgb(L_val, a_val, b_val);
            
            output.data[dataIndex] = r * 255;
            output.data[dataIndex + 1] = g * 255;
            output.data[dataIndex + 2] = b * 255;
            output.data[dataIndex + 3] = 255;
        }
    }
    
    return output;
}

// Usando punto blanco D65 como referencia
function rgbToLab(r, g, b) {
    // 1) RGB -> XYZ (aplicar gamma inversa)
    r = r > 0.04045 ? Math.pow((r + 0.055) / 1.055, 2.4) : r / 12.92;
    g = g > 0.04045 ? Math.pow((g + 0.055) / 1.055, 2.4) : g / 12.92;
    b = b > 0.04045 ? Math.pow((b + 0.055) / 1.055, 2.4) : b / 12.92;

    // Matriz de transformacin RGB a XYZ (sRGB/D65)
    const X = r * 0.4124564 + g * 0.3575761 + b * 0.1804375;
    const Y = r * 0.2126729 + g * 0.7151522 + b * 0.0721750;
    const Z = r * 0.0193339 + g * 0.1191920 + b * 0.9503041;

    // 2) XYZ -> Lab
    const xn = X / 0.95047;
    const yn = Y / 1.00000;
    const zn = Z / 1.08883;

    const delta = 6.0 / 29.0;
    const delta2 = delta * delta;
    const delta3 = delta2 * delta;
    
    const f = t => t > delta3 ? Math.pow(t, 1/3) : (t / (3 * delta2)) + (4.0 / 29.0);
    
    const fx = f(xn);
    const fy = f(yn);
    const fz = f(zn);
    
    return [
        116 * fy - 16,  // L
        500 * (fx - fy), // a
        200 * (fy - fz)  // b
    ];
}

function labToRgb(L, a, b) {
    // Validar rangos de entrada
    L = Math.max(0, Math.min(100, L));
    a = Math.max(-128, Math.min(127, a));
    b = Math.max(-128, Math.min(127, b));

    // 1) Lab -> XYZ
    const fy = (L + 16) / 116;
    const fx = a / 500 + fy;
    const fz = fy - b / 200;
    
    // Constantes del espacio Lab
    const delta = 6.0 / 29.0;
    const delta2 = delta * delta;
    
    // Funcin inversa f^-1
    const finv = t => t > delta ? t * t * t : 3 * delta2 * (t - 4 / 29);
    
    // Aplicar punto blanco D65
    const X = 0.95047 * finv(fx);
    const Y = 1.00000 * finv(fy);
    const Z = 1.08883 * finv(fz);

    // 2) XYZ -> RGB (matriz inversa sRGB/D65)
    let r = X *  3.2406 + Y * -1.5372 + Z * -0.4986;
    let g = X * -0.9689 + Y *  1.8758 + Z *  0.0415;
    let b_val = X *  0.0557 + Y * -0.204 + Z *  1.0570;

    // Aplicar correccin gamma
    const gammaCorrect = val => {
        if (val <= 0.0031308) {
            return 12.92 * val;
        } else {
            return 1.055 * Math.pow(val, 1/2.4) - 0.055;
        }
    };

    r = gammaCorrect(r);
    g = gammaCorrect(g);
    b_val = gammaCorrect(b_val);

    if (isNaN(r) || isNaN(g) || isNaN(b_val)) {
        console.warn("Valores NaN detectados en labToRgb:", {L, a, b, X, Y, Z});
        return [0, 0, 0]; // Negro como fallback
    }

    // Clamp a [0, 1]
    return [
        Math.max(0, Math.min(1, r)),
        Math.max(0, Math.min(1, g)),
        Math.max(0, Math.min(1, b_val))
    ];
}

// Convierte una imagen a escala de grises y la redimensiona a 512x512 pxeles, asumiendo que la imagen de entrada 
// est idealmente en formato WebP (i.e. RGBA, aunque funciona con cualquier formato soportado por canvas).
// Devuelve un objeto ImageData con los pxeles procesados, as como los valores a y b de Lab originales.
function preprocessImageToGrayscale(imgElement, Nx, Ny) {
    // Create canvas with original dimensions
    const canvas = document.createElement('canvas');
    canvas.width = imgElement.width;
    canvas.height = imgElement.height;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
    
    // Get original image data
    const originalImageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
    const data = originalImageData.data;
    const totalPixels = canvas.width * canvas.height;

    // Prepare arrays for Lab components
    const LData = new Float32Array(totalPixels);
    const aData = new Float32Array(totalPixels);
    const bData = new Float32Array(totalPixels);

    // Convert RGB to Lab for each pixel
    for (let i = 0; i < totalPixels; i++) {
        const r = data[i * 4] / 255;
        const g = data[i * 4 + 1] / 255;
        const b = data[i * 4 + 2] / 255;
        
        // Convert RGB to Lab
        const [L, a, b_] = rgbToLab(r, g, b);
        
        LData[i] = L;
        aData[i] = a;
        bData[i] = b_;
    }

    // Create grayscale image (using just L channel) with target dimensions (Nx, Ny)
    const targetCanvas = document.createElement('canvas');
    targetCanvas.width = Nx;
    targetCanvas.height = Ny;
    const targetCtx = targetCanvas.getContext('2d');
    
    // Draw original image resized to target dimensions
    targetCtx.drawImage(imgElement, 0, 0, Nx, Ny);
    const targetImageData = targetCtx.getImageData(0, 0, Nx, Ny);
    const targetData = targetImageData.data;
    
    // Convert to grayscale (L channel)
    for (let i = 0; i < Nx * Ny; i++) {
        const r = targetData[i * 4];
        const g = targetData[i * 4 + 1];
        const b = targetData[i * 4 + 2];
        // const luminance = L / 100.0; // Con Lab
        // const luminance = 0.2126 * r + 0.7152 * g + 0.0722 * b; // Con Rec. 709 (sRGB)
        const luminance = 0.299 * r + 0.587 * g + 0.114 * b; // Con Rec. 601 (BT.709)
        targetData[i * 4] = luminance;
        targetData[i * 4 + 1] = luminance;
        targetData[i * 4 + 2] = luminance;
        targetData[i * 4 + 3] = 255;
    }

    return {
        imageData: targetImageData,  // Grayscale image with target dimensions
        LData,                      // Original L channel
        aData,                      // Original a channel
        bData                       // Original b channel
    };
}

function getHeightMapFromImageData(imageData, targetWidth, targetHeight) {
  const { data, width: imgWidth, height: imgHeight } = imageData;
  const heightMap = new Float32Array(targetWidth * targetHeight);
  
  // Muestreo con interpolacin bilineal
  for (let y = 0; y < targetHeight; y++) {
    for (let x = 0; x < targetWidth; x++) {
      // Coordenadas normalizadas
      const u = x / (targetWidth - 1);
      const v = y / (targetHeight - 1);
      
      // Coordenadas en la imagen
      const imgX = u * (imgWidth - 1);
      const imgY = v * (imgHeight - 1);
      
      // Interpolacin bilineal
      const x1 = Math.floor(imgX);
      const y1 = Math.floor(imgY);
      const x2 = Math.min(x1 + 1, imgWidth - 1);
      const y2 = Math.min(y1 + 1, imgHeight - 1);
      
      // Valores de los 4 pxeles circundantes
      const q11 = data[(y1 * imgWidth + x1) * 4] / 255;
      const q12 = data[(y2 * imgWidth + x1) * 4] / 255;
      const q21 = data[(y1 * imgWidth + x2) * 4] / 255;
      const q22 = data[(y2 * imgWidth + x2) * 4] / 255;
      
      // Interpolacin
      const heightValue = bilinearInterpolation(
        imgX - x1, imgY - y1,
        q11, q12, q21, q22
      );
      
      heightMap[y * targetWidth + x] = heightValue;
    }
  }

  return heightMap;
}

function bilinearInterpolation(x, y, q11, q12, q21, q22) {
  return q11 * (1 - x) * (1 - y) +
         q21 * x * (1 - y) +
         q12 * (1 - x) * y +
         q22 * x * y;
}

function createHeightMesh(heightMapFlat, subdivisionsX, subdivisionsY, normalize = false, scale = 1, usePercentiles = false, enhanceContrast = false) {
  // Usamos BufferGeometry para mejor control
  const geometry = new THREE.BufferGeometry();

  const width = subdivisionsX;
  const height = subdivisionsY;
  const sizeX = 10;
  const sizeY = 10 * (height / width);
  
  // Crear vrtices
  const vertices = new Float32Array(width * height * 3);
  const uvs = new Float32Array(width * height * 2);
  
  // Clculo de rango dinmico
  let min, max, range;
  
  if (usePercentiles) {
    // Ajuste de rango dinmico con percentiles (5% y 95%) para evitar outliers
    const sortedHeights = [...heightMapFlat].sort((a, b) => a - b);
    min = sortedHeights[Math.floor(sortedHeights.length * 0.05)];
    max = sortedHeights[Math.floor(sortedHeights.length * 0.95)];
  } else {
    // Usando mnimo y mximo absolutos
    min = Math.min(...heightMapFlat);
    max = Math.max(...heightMapFlat);
  }
  range = max - min || 1; // Evitar divisin por cero

  let vertexIndex = 0;
  let uvIndex = 0;
  
  for (let y = 0; y < height; y++) {
    for (let x = 0; x < width; x++) {
      // Posicin XZ
      const px = (x / (width - 1) - 0.5) * sizeX;
      const pz = (y / (height - 1) - 0.5) * sizeY;
      
      // Altura normalizada (si acaso con ajuste no lineal para mejor contraste)
      let py;
      const heightValue = heightMapFlat[y * width + x];
      if (normalize) {
        let normalizedHeight = (heightValue - min) / range;
        if (enhanceContrast) {
          normalizedHeight = Math.pow(normalizedHeight, 1.5);
        }
        py = normalizedHeight * scale;
      }
      else {
        py = heightValue;
      }
      
      // Asignar vrtices
      vertices[vertexIndex++] = px;
      vertices[vertexIndex++] = py;
      vertices[vertexIndex++] = pz;
      
      // Coordenadas UV
      uvs[uvIndex++] = x / (width - 1);
      uvs[uvIndex++] = 1 - (y / (height - 1));
    }
  }
  
  // Crear ndices para las caras
  const indices = [];
  for (let y = 0; y < height - 1; y++) {
    for (let x = 0; x < width - 1; x++) {
      const a = y * width + x;
      const b = y * width + x + 1;
      const c = (y + 1) * width + x;
      const d = (y + 1) * width + x + 1;
      
      indices.push(a, b, d);
      indices.push(a, d, c);
    }
  }
  
  // Asignar atributos a la geometra
  geometry.setAttribute('position', new THREE.BufferAttribute(vertices, 3));
  geometry.setAttribute('uv', new THREE.BufferAttribute(uvs, 2));
  geometry.setIndex(indices);
  
  // Poner en el plano horizontal
  geometry.rotateX(- Math.PI / 2);
  geometry.rotateZ(Math.PI / 2);
  geometry.rotateY(Math.PI);

  // Calcular normales
  geometry.computeVertexNormals();
  
  // Crear atributo de color (valor inicial 0.5)
  const colors = new Float32Array(width * height * 3);
  for (let i = 0; i < colors.length; i++) {
      colors[i] = 0.533; // 0x88 en [0-1]
  }
  geometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
  
  // Material mejorado
  const material = new THREE.MeshStandardMaterial({
    vertexColors: true, // Habilitar el uso de colores de vrtices
    roughness: 0.7,
    metalness: 0.3,
    side: THREE.DoubleSide,
    flatShading: false
  });
  // const material = new THREE.MeshBasicMaterial({
  //   vertexColors: true,
  //   side: THREE.DoubleSide
  // });
  
  const mesh = new THREE.Mesh(geometry, material);
  mesh.name = "mesh";
  mesh.rotation.x = -Math.PI / 2;
  
  // Creear wireframe
  const wireframe = new THREE.LineSegments(
    new THREE.WireframeGeometry(geometry),
    new THREE.LineBasicMaterial({
        color: 0x888888,          
        transparent: true,
        opacity: 0.5            
    })
  );
  wireframe.name = "wireframe";
  wireframe.rotation.x = -Math.PI / 2;

  // Agrupar ambos
  const meshGroup = new THREE.Group();
  meshGroup.add(mesh);
  meshGroup.add(wireframe);

  return meshGroup;
}

class Solver {
    // Tipos de PDEs a resolver
    static PDE_TYPES = {
        HEAT: 'heat',       // Ecuacin de difusin, o de conduccin, o de calor, o de Fourier
        WAVE: 'wave',       // Ecuacin de onda
        EXPONENTIAL_DECAY: 'exponential-decay', // Ley del decaimiento exponencial du/dt = u
        // GENERAL_WAVE: '?',  // Generaliza la de onda
        // LAPLACE: 'laplace'  // Ecuacin de Laplace
    };

    // Tipos de condiciones de frontera soportadas
    static BOUNDARY_TYPES = {
        DIRICHLET: 'dirichlet',       // Valores fijos (puede ser cualquier valor)
        ZERO: 'zero',                 // Caso especial de Dirichlet con u=0
        NEUMANN: 'neumann',           // Derivada fija (flujo constante)
        FIXED: 'fixed',               // Valores originales (de u_0)
        REFLECTIVE: 'reflective',     // Caso especial de Neumann con u/n=0
        PERIODIC: 'periodic',         // Bordes conectados (izq-der, arr-aba)
        ROBIN: 'robin',               // Condicin mixta (u + u/n = )
        // MIXED: 'mixed',            // Diferentes tipos en diferentes bordes
        // CAUCHY: 'cauchy'           // Condicin general de primer orden
    };

    // Tipos de esquemas numricos para resolver las PDEs
    static SCHEME_TYPES = {
        FORWARD_EULER: 'forward-euler',  // Explcito
        BACKWARD_EULER: 'backward-euler' // Implcito 
    };

    constructor({
        // Valores por defecto
        imageData,
        deltaPx = 1.0,
        dt = 0.1,
        pdeType = 'heat',
        boundaryType = 'periodic',
        schemeType = 'forward-euler'
    }) {
        this.width = imageData.width;
        this.height = imageData.height;
        this.deltaPx = deltaPx;
        this.dt = dt;

        // Parmetros especficos de PDEs
        this.c = 50.0;
        this.alpha = 10.0;
        this.lambda = 10.0;

        const validPdeTypes = Object.values(Solver.PDE_TYPES);
        const validBoundaryTypes = Object.values(Solver.BOUNDARY_TYPES);
        const validSchemeTypes = Object.values(Solver.SCHEME_TYPES);

        this.pdeType = validPdeTypes.includes(pdeType.toLowerCase()) ? pdeType.toLowerCase() : Solver.PDE_TYPES.HEAT;
        this.boundaryType = validBoundaryTypes.includes(boundaryType.toLowerCase()) ? boundaryType.toLowerCase() : Solver.BOUNDARY_TYPES.PERIODIC;
        this.schemeType = validSchemeTypes.includes(schemeType.toLowerCase()) ? schemeType.toLowerCase() : Solver.SCHEME_TYPES.FORWARD_EULER;

        this.calculateCoefficient();

        // Verificar condicin de estabilidad solo para esquemas explcitos
        if (this.schemeType === Solver.SCHEME_TYPES.FORWARD_EULER) {
            if (this.pdeType === Solver.PDE_TYPES.HEAT && this.coeff > 0.5) {
                console.warn(`Condicin de estabilidad no satisfecha para ecuacin de calor! (${this.coeff} > 0.5). La simulacin puede ser inestable. Considera usar otro esquema.`);
            }

            if (this.pdeType === Solver.PDE_TYPES.WAVE && this.coeff > 1.0) {
                console.warn(`Condicin de CFL no satisfecha para ecuacin de onda! (${Math.sqrt(this.coeff)} > 1). La simulacin puede ser inestable. Considera usar otro esquema.`);
            }

            if (this.pdeType === Solver.PDE_TYPES.EXPONENTIAL_DECAY && this.dt > 2 / this.lambda) {
                console.warn(`Condicin de estabilidad no satisfecha para decaimiento exponencial! (${this.dt} > 2/). La simulacin puede ser inestable.`);
            }
        }

        // Normalizar imagen
        this.imageData = this.cloneImageData(imageData);
        this.reset();

        // Guardar estado original para condiciones FIXED
        if (this.boundaryType === Solver.BOUNDARY_TYPES.FIXED) {
            this.originalState = this.deepCopyMatrix(this.currentState);
        }
    }

    normalizeImageData(imageData) {
        const matrix = [];
        for (let y = 0; y < this.height; y++) {
            const row = [];
            for (let x = 0; x < this.width; x++) {
                const idx = (y * this.width + x) * 4;
                row.push(imageData.data[idx] / 255.0); // Normalizar a [0,1] y almacenar
            }
            matrix.push(row);
        }
        return matrix;
    }

    step() {
        if (this.pdeType === Solver.PDE_TYPES.HEAT) {
            return this.stepHeatEquation();
        } else if (this.pdeType === Solver.PDE_TYPES.WAVE) {
            return this.stepWaveEquation();
        } else {
            return this.stepExpDecayEquation();
        }
    }

    stepHeatEquation() {
        // Ecuacin de calor: u/t = cu
        if (this.schemeType === Solver.SCHEME_TYPES.FORWARD_EULER) {
            return this.stepHeatEquationFE();
        } else {
            return this.stepHeatEquationBE();
        }
    }

    stepHeatEquationFE() {
        // Forward Euler explcito para ecuacin de calor
        for (let y = 1; y < this.height - 1; y++) {
            for (let x = 1; x < this.width - 1; x++) {
                const laplacian = (
                    this.currentState[y][x - 1] +
                    this.currentState[y][x + 1] +
                    this.currentState[y - 1][x] +
                    this.currentState[y + 1][x] -
                    4 * this.currentState[y][x]
                );

                this.nextState[y][x] = this.currentState[y][x] + this.coeff * laplacian;
                this.nextState[y][x] = this.clamp_zero_one(this.nextState[y][x]);
            }
        }

        this.applyBoundaryConditions();

        [this.currentState, this.nextState] = [this.nextState, this.currentState];

        return this.denormalizeToImageData(this.currentState);
    }

    stepHeatEquationBE() {
        // Backward Euler implcito para ecuacin de calor
        // Necesitamos resolver un sistema lineal: (I - coeff * L) u^{n+1} = u^n
        // Donde L es el operador laplaciano discreto

        // Para simplificar, usamos Jacobi iteration para resolver el sistema
        const maxIter = 50;
        const tolerance = 1e-4;

        // Inicializar solucin con el estado actual
        for (let y = 0; y < this.height; y++) {
            for (let x = 0; x < this.width; x++) {
                this.nextState[y][x] = this.currentState[y][x];
            }
        }

        for (let iter = 0; iter < maxIter; iter++) {
            let maxDiff = 0;

            const tempState = this.deepCopyMatrix(this.nextState); // Jacobi necesita una copia del estado anterior

            for (let y = 1; y < this.height - 1; y++) {
                for (let x = 1; x < this.width - 1; x++) {
                    const rhs = this.currentState[y][x];

                    const neighborSum =
                        tempState[y][x - 1] +
                        tempState[y][x + 1] +
                        tempState[y - 1][x] +
                        tempState[y + 1][x];

                    const newValue = (rhs + this.coeff * neighborSum) / (1 + 4 * this.coeff);
                    const diff = Math.abs(newValue - this.nextState[y][x]);
                    if (diff > maxDiff) maxDiff = diff;

                    this.nextState[y][x] = this.clamp_zero_one(newValue);
                }
            }

            this.applyBoundaryConditions();

            if (maxDiff < tolerance) break;
        }

        [this.currentState, this.nextState] = [this.nextState, this.currentState];

        return this.denormalizeToImageData(this.currentState);
    }

    stepWaveEquation() {
        // Ecuacin de onda: u/t = cu
        if (this.schemeType === Solver.SCHEME_TYPES.FORWARD_EULER) {
            return this.stepWaveEquationFE();
        } else {
            return this.stepWaveEquationBE();
        }
    }

    stepWaveEquationFE() {
        // Forward Euler explcito para ecuacin de onda
        for (let y = 1; y < this.height - 1; y++) {
            for (let x = 1; x < this.width - 1; x++) {
                const laplacian = (
                    this.currentState[y][x - 1] +
                    this.currentState[y][x + 1] +
                    this.currentState[y - 1][x] +
                    this.currentState[y + 1][x] -
                    4 * this.currentState[y][x]
                );

                this.nextState[y][x] =
                    2 * this.currentState[y][x] -
                    this.previousState[y][x] +
                    this.coeff * laplacian;

                this.nextState[y][x] = this.clamp_zero_one(this.nextState[y][x]);
            }
        }

        this.applyBoundaryConditions();

        [this.previousState, this.currentState, this.nextState] = [this.currentState, this.nextState, this.previousState];

        return this.denormalizeToImageData(this.currentState);
    }

    stepWaveEquationBE() {
        // Backward Euler implcito para ecuacin de onda
        // Necesitamos resolver un sistema lineal: (I - coeff * L) u^{n+1} = 2u^n - u^{n-1} + coeff * L u^n
        // Es ms complejo que para la ecuacin de calor

        // Para simplificar, usamos un enfoque semi-implcito aqu
        const maxIter = 25; // Ms de 25 se vio que afecta gravemente a los FPS
        const tolerance = 1e-4;

        // Inicializar con currentState
        for (let y = 0; y < this.height; y++) {
            for (let x = 0; x < this.width; x++) {
                this.nextState[y][x] = this.currentState[y][x];
            }
        }

        for (let iter = 0; iter < maxIter; iter++) {
            let maxDiff = 0;
            const temp = this.deepCopyMatrix(this.nextState);

            for (let y = 1; y < this.height - 1; y++) {
                for (let x = 1; x < this.width - 1; x++) {
                    // RHS = 2*u^n - u^{n-1}
                    const rhs = 2 * this.currentState[y][x] - this.previousState[y][x];

                    // Jacobi iteration
                    const neighborSum =
                        temp[y][x - 1] +
                        temp[y][x + 1] +
                        temp[y - 1][x] +
                        temp[y + 1][x];

                    const newValue = (rhs + this.coeff * neighborSum) / (1 + 4 * this.coeff);
                    const diff = Math.abs(newValue - this.nextState[y][x]);
                    if (diff > maxDiff) maxDiff = diff;

                    this.nextState[y][x] = this.clamp_zero_one(newValue);
                }
            }

            this.applyBoundaryConditions();

            if (maxDiff < tolerance) break;
        }

        // Actualizar los estados
        [this.previousState, this.currentState, this.nextState] = [this.currentState, this.nextState, this.previousState];

        return this.denormalizeToImageData(this.currentState);
    }

    stepExpDecayEquation() {
        // Ecuacin de decaimiento exponencial: u/t = -u = f(u, t)
        for (let y = 0; y < this.height; y++) {
            for (let x = 0; x < this.width; x++) {
                const current = this.currentState[y][x];

                if (this.schemeType === Solver.SCHEME_TYPES.FORWARD_EULER) {
                    this.nextState[y][x] = this.clamp_zero_one(current * this.coeff);
                } else {
                    this.nextState[y][x] = this.clamp_zero_one(current * this.coeff);
                }
            }
        }

        [this.currentState, this.nextState] = [this.nextState, this.currentState];

        return this.denormalizeToImageData(this.currentState);
    }

    applyBoundaryConditions() {
        const { width, height } = this;

        switch (this.boundaryType.toLowerCase()) {
            // BORDES PERIDICOS
            case Solver.BOUNDARY_TYPES.PERIODIC:
                for (let y = 0; y < height; y++) {
                    this.nextState[y][0] = this.nextState[y][width - 2];
                    this.nextState[y][width - 1] = this.nextState[y][1];
                }
                for (let x = 0; x < width; x++) {
                    this.nextState[0][x] = this.nextState[height - 2][x];
                    this.nextState[height - 1][x] = this.nextState[1][x];
                }
                break;

            // BORDES DIRICHLET: valores fijos originales (en concreto, aqu decimos que sea el borde de la condicin inicial)
            case Solver.BOUNDARY_TYPES.DIRICHLET:
                const fixedValue = 0.5;
                for (let y = 0; y < height; y++) {
                    this.nextState[y][0] = fixedValue;
                    this.nextState[y][width - 1] = fixedValue;
                }
                for (let x = 0; x < width; x++) {
                    this.nextState[0][x] = fixedValue;
                    this.nextState[height - 1][x] = fixedValue;
                }
                break;

            // BORDES EN CERO (caso especial de Dirichlet con valor 0)
            case Solver.BOUNDARY_TYPES.ZERO:
                for (let y = 0; y < height; y++) {
                    this.nextState[y][0] = 0.0;
                    this.nextState[y][width - 1] = 0.0;
                }
                for (let x = 0; x < width; x++) {
                    this.nextState[0][x] = 0.0;
                    this.nextState[height - 1][x] = 0.0;
                }
                break;

            // BORDES FIXED: valor fijo constante (es Dirichlet, pero con valores fijos para todo el borde)
            case Solver.BOUNDARY_TYPES.FIXED:
                for (let y = 0; y < height; y++) {
                    this.nextState[y][0] = this.originalState[y][0];
                    this.nextState[y][width - 1] = this.originalState[y][width - 1];
                }
                for (let x = 0; x < width; x++) {
                    this.nextState[0][x] = this.originalState[0][x];
                    this.nextState[height - 1][x] = this.originalState[height - 1][x];
                }
                break;

            case Solver.BOUNDARY_TYPES.NEUMANN:
                // Derivada normal constante: u/n = du_dn
                const du_dn = 1.0;

                for (let y = 0; y < height; y++) {
                    // Borde izquierdo (x = 0): u[0] = u[1] - dx * du_dn
                    this.nextState[y][0] = this.nextState[y][1] - this.deltaPx * du_dn;

                    // Borde derecho (x = width - 1): u[N-1] = u[N-2] + dx * du_dn
                    this.nextState[y][width - 1] = this.nextState[y][width - 2] + this.deltaPx * du_dn;
                }

                for (let x = 0; x < width; x++) {
                    // Borde superior (y = 0): u[0] = u[1] - dy * du_dn
                    this.nextState[0][x] = this.nextState[1][x] - this.deltaPx * du_dn;

                    // Borde inferior (y = height - 1): u[N-1] = u[N-2] + dy * du_dn
                    this.nextState[height - 1][x] = this.nextState[height - 2][x] + this.deltaPx * du_dn;
                }
                break;

            case Solver.BOUNDARY_TYPES.REFLECTIVE:
                // Caso especial de Neumann con u/n=0 (conservacin de energa)
                for (let y = 0; y < height; y++) {
                    this.nextState[y][0] = this.nextState[y][1];
                    this.nextState[y][width - 1] = this.nextState[y][width - 2];
                }
                for (let x = 0; x < width; x++) {
                    this.nextState[0][x] = this.nextState[1][x];
                    this.nextState[height - 1][x] = this.nextState[height - 2][x];
                }
                break;

            case Solver.BOUNDARY_TYPES.ROBIN:
                // Condicin mixta: u + u/n = 
                const alpha = 1.0;
                const beta = 1.0;
                const gamma = 0.0;

                for (let y = 0; y < height; y++) {
                    // Borde izquierdo (x = 0)
                    this.nextState[y][0] = (beta * this.nextState[y][1] + gamma) / (beta + alpha);

                    // Borde derecho (x = width - 1)
                    this.nextState[y][width - 1] = (beta * this.nextState[y][width - 2] + gamma) / (beta + alpha);
                }

                for (let x = 0; x < width; x++) {
                    // Borde superior (y = 0)
                    this.nextState[0][x] = (beta * this.nextState[1][x] + gamma) / (beta + alpha);

                    // Borde inferior (y = height - 1)
                    this.nextState[height - 1][x] = (beta * this.nextState[height - 2][x] + gamma) / (beta + alpha);
                }
                break;

            // case Solver.BOUNDARY_TYPES.MIXED:
            //     //...
            //     break;

            // case Solver.BOUNDARY_TYPES.CAUCHY:
            //     //...
            //     break;

            default:
                console.warn(`Tipo de condicin de frontera no reconocido: ${this.boundaryType}. Usando peridica por defecto.`);
                // Bordes peridicos por defecto
                for (let y = 0; y < height; y++) {
                    this.nextState[y][0] = this.nextState[y][width - 2];
                    this.nextState[y][width - 1] = this.nextState[y][1];
                }
                for (let x = 0; x < width; x++) {
                    this.nextState[0][x] = this.nextState[height - 2][x];
                    this.nextState[height - 1][x] = this.nextState[1][x];
                }
                break;
        }
    }

    setBoundaryType(newBoundaryType) {
        if (Object.values(Solver.BOUNDARY_TYPES).includes(newBoundaryType)) {
            this.boundaryType = newBoundaryType;

            // Si es FIXED, se necesita guardar el estado actual como el original
            if (this.boundaryType === Solver.BOUNDARY_TYPES.FIXED) {
                this.originalState = this.deepCopyMatrix(this.currentState);
            }
        } else {
            console.warn(`Tipo de condicin de frontera no vlido: ${newBoundaryType}`);
        }
    }

    setPDEType(newPdeType) {
        if (Object.values(Solver.PDE_TYPES).includes(newPdeType)) {
            this.pdeType = newPdeType;
            this.calculateCoefficient(); // Recalcular coeficiente
        } else {
            console.warn(`Tipo de PDE no vlido: ${newPdeType}`);
        }
    }

    setSchemeType(newSchemeType) {
        if (Object.values(Solver.SCHEME_TYPES).includes(newSchemeType)) {
            this.schemeType = newSchemeType;
        } else {
            console.warn(`Tipo de esquema no vlido: ${newSchemeType}`);
        }
    }

    calculateCoefficient() {
        // Asumiendo deltaPx == deltaX = deltaY
        switch (this.pdeType) {
            case Solver.PDE_TYPES.HEAT:
            {
                this.coeff = (this.c * this.dt) / (this.deltaPx * this.deltaPx); // Para ecuacin de calor
                break;                    
            }

            case Solver.PDE_TYPES.WAVE:
            {
                this.coeff = (this.c * this.dt / this.deltaPx) ** 2; // Para ecuacin de onda
                break;
            }

            case Solver.PDE_TYPES.EXPONENTIAL_DECAY:
            {
                if (this.schemeType === Solver.SCHEME_TYPES.FORWARD_EULER) {
                    // Forward Euler: u^{n+1} = u^n + dt * f(u^n, t^n) <=> u^{n+1} = u^n - dt *  * u^n
                    this.coeff = 1 - this.lambda * this.dt;      
                } else {
                    // Backward Euler: u^{n+1} = u^n + dt * f(u^{n+1}, t^{n+1}) <=>  u^{n+1} = u^n / (1 + dt * )
                    this.coeff = 1 / (1 + this.lambda * this.dt); 
                }
                break;
            }

            default:
                throw new Error('Tipo de PDE no soportado');
        }
    }

    denormalizeToImageData(matrix) {
        const newImageData = new ImageData(this.width, this.height);
        for (let y = 0; y < this.height; y++) {
            for (let x = 0; x < this.width; x++) {
                const idx = (y * this.width + x) * 4;
                const value = Math.round(matrix[y][x] * 255);
                // Asignar el mismo valor a R, G, B (escala de grises)
                newImageData.data[idx] = value;     // R
                newImageData.data[idx + 1] = value; // G
                newImageData.data[idx + 2] = value; // B
                newImageData.data[idx + 3] = 255;   // Alpha (totalmente opaco)
            }
        }
        return newImageData;
    }

    createZeroMatrix() {
        return Array.from({ length: this.height }, () => Array(this.width).fill(0));
    }

    cloneImageData(imageData) {
        const canvas = document.createElement('canvas');
        canvas.width = imageData.width;
        canvas.height = imageData.height;
        const ctx = canvas.getContext('2d');
        ctx.putImageData(imageData, 0, 0);
        return ctx.getImageData(0, 0, canvas.width, canvas.height);
    }

    deepCopyMatrix(matrix) {
        return matrix.map(row => row.slice());
    }

    // Clamping estricto tras cada iteracin
    clamp_zero_one(value) {
        return Math.max(0, Math.min(1, value));
    }

    // Volver a condiciones iniciales
    reset() {
        this.currentState = this.deepCopyMatrix(this.normalizeImageData(this.imageData));  // u_k = u_0
        this.previousState = this.deepCopyMatrix(this.currentState); // u_prev = u_k
        this.nextState = this.createZeroMatrix();
    }
}

// Variables globales
let runSimulation = false;
let solver;
let originalImageData; // u_0
let Nx = 256, Ny = 256;
let meshGeometry; // Dnde estn los vrtices de tu superficie 3D que representan la altura de cada pxel
let positionAttribute; // Buffer (que el solver utiliza) que guarda los coordenadas (x, y, z) de cada vrtice 
let currentImageData; // Imagen en cada paso, que se muestra en canvas2d
let needToUpdate = false; 
let meshGroup; // Mesh + wireframe
let toggledE = false; // Modo pantalla pseudo-completa con la tecla E
let currentColormapId = 'viridis';
let originalWidth, originalHeight;
let originala = null;
let originalb = null;
let originalR = null;
let originalG = null;
let originalB_ = null;
let normalizeHeights = false; // Normalizacin de la altura de la malla en cada paso (efecto visual)
let lastTime = 0;
let speedAnimation = 50;

// Enlaczar elementos UI
const wireframeCheck = document.getElementById("wireframe-check");
const meshCheck = document.getElementById("mesh-check");
const runCheck = document.getElementById("run-check");
const canvas3dContainer = document.getElementById('canvas3d-container');
const originalZ = window.getComputedStyle(canvas3dContainer).zIndex || '0';
const fileUpload = document.getElementById('file-upload');
const boundarySelect = document.getElementById("boundary-select");
const pdeSelect = document.getElementById("pde-select");
const schemeSelect = document.getElementById("scheme-select");
const colormapSelect = document.getElementById("colormap-select");
const resetButton = document.getElementById("reset-button");
const velocitySlider = document.getElementById('speed-slider');
const velocityValue = document.getElementById('velocity-value');

// Configuracin canvas 2D
const canvas2d = document.getElementById("canvas2d");
const ctx2d = canvas2d.getContext("2d");

// Configuracin del canvas de Three.js
const scene = new THREE.Scene();
scene.background = new THREE.Color(0x121212);

// Configurar luz 
const light = new THREE.DirectionalLight(0xffffff, 0.75);
light.position.set(0, 5, 0);
scene.add(light);
const light2 = new THREE.DirectionalLight(0xffffff, 0.5);
light2.position.set(0, -5, 0);
scene.add(light2);

// Configuracin inicial de cmara
const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
camera.position.set(5, 7.5, 5);

// Configurar el renderer WebGL con nuestro canvas
const canvas3d = document.getElementById("canvas3d");
const renderer = new THREE.WebGLRenderer({ antialias: true, canvas: canvas3d });
renderer.setPixelRatio(window.devicePixelRatio);
renderer.setSize(window.innerWidth, window.innerHeight);

// Configurar control de la cmara
const controls = new OrbitControls(camera, renderer.domElement);
controls.enableDamping = true; // movimiento suave
controls.dampingFactor = 0.15;

// Configurar ejes del mundo personalizados
const axes = createAxes();
scene.add(axes.x);
scene.add(axes.y);
scene.add(axes.z);
{
    originalWidth = Nx;
    originalHeight = Ny;
    originalImageData = createSampleImage();
    currentImageData = originalImageData;

    const totalPixels = Nx * Ny;
    originala = new Float32Array(totalPixels).fill(0);
    originalb = new Float32Array(totalPixels).fill(0);
    originalR = new Float32Array(totalPixels);
    originalG = new Float32Array(totalPixels);
    originalB_ = new Float32Array(totalPixels);
    const data = originalImageData.data;
    for (let i = 0; i < totalPixels; i++) {
        originalR[i] = data[i * 4];
        originalG[i] = data[i * 4 + 1];
        originalB_[i] = data[i * 4 + 2];
    }
    initializeSimulation();
}

// Usar Stats.js para mostrar los FPS y modifica directamente en inline el estilo
const stats = new Stats();
stats.showPanel(0); // 0 = FPS, 1 = ms, 2 = MB, 3 = custom
stats.dom.style.position = 'fixed';
stats.dom.style.left = 'auto';    
stats.dom.style.top = 'auto';   
stats.dom.style.right = '0px';   
stats.dom.style.bottom = '0px';  
stats.dom.classList.add('stats');
document.body.appendChild(stats.dom);

// Bucle de animacin principal, que se llama continuamente gracias a requestAnimationFram, que pide que se 
// ejecute la funcin que se le pase antes del siguiente repintado de pantalla.
function animate(time = 0) {
    stats.begin();

    controls.update();

    const thresholdToHighSpeed = 50;
    if (runSimulation && solver) {
        if (speedAnimation === 0) ; else if (speedAnimation <= thresholdToHighSpeed) {
            // Ms lento, ejecuta cada cierto tiempo
            // Intervalo entre pasos: de 1000 ms (speed=1) a 20 ms (speed=thresholdToHighSpeed)
            const maxInterval = 1000;
            const minInterval = 20;
            const interval = maxInterval - ((speedAnimation - 1) / (thresholdToHighSpeed - 1)) * (maxInterval - minInterval);
            
            if (time - lastTime > interval) {
                currentImageData = solver.step();
                updateVisuals(currentImageData);
                needToUpdate = true;
                lastTime = time;
            }
        } else {
            // Ms rpido, ejecuta varios pasos por frame
            // stepsPerFrame: de 1 (speed=thresholdToHighSpeed) a 10 (speed=100)
            const minSteps = 1;
            const maxSteps = 10;
            const stepsPerFrame = Math.round(minSteps + ((speedAnimation - (thresholdToHighSpeed + 1)) / (thresholdToHighSpeed - 1)) * (maxSteps - minSteps));
            
            for (let i = 0; i < stepsPerFrame; i++) {
                currentImageData = solver.step();
            }
            updateVisuals(currentImageData);
            needToUpdate = true;
        }
    }

    if (needToUpdate) {
        positionAttribute.needsUpdate = true;
        meshGeometry.computeVertexNormals();
        needToUpdate = false;
    }

    renderer.render(scene, camera);

    stats.end();

    requestAnimationFrame(animate);
}

animate();

// Event listeners
window.addEventListener('resize', handleResize);
wireframeCheck.addEventListener("change", toggleWireframe);
meshCheck.addEventListener("change", toggleMesh);
runCheck.addEventListener("change", toggleRun);
fileUpload.addEventListener('change', handleImageUpload);
boundarySelect.addEventListener("change", handleBoundaryChange);
pdeSelect.addEventListener("change", handlePDEChange);
schemeSelect.addEventListener("change", handleSchemeChange);
colormapSelect.addEventListener("change", handleColormapChange);
resetButton.addEventListener("click", setInitialCondition);
velocitySlider.addEventListener("input", setVelocity);

// Helper functions
function initializeSimulation() {
    // Disparar los eventos para inializar el sistema
    // wireframeCheck.dispatchEvent(new Event('change'));
    meshCheck.dispatchEvent(new Event('change'));
    runCheck.dispatchEvent(new Event('change'));

    solver = new Solver({
        imageData: currentImageData,
        deltaPx: 1.0, // deltaPx == deltaX = deltaY
        dt: 0.005,
        pdeType: document.getElementById('pde-select').value || 'heat',
        boundaryType: document.getElementById('boundary-select').value || 'reflective',
        schemeType: document.getElementById('scheme-select').value || 'forward-euler'
    });

    updateVisuals(currentImageData);
}

// Cargar textura de ejemplo
function createSampleImage() {
    const canvas = document.createElement('canvas');
    canvas.width = Nx;
    canvas.height = Ny;
    
    // Usar el contexto del canvas temporal, no el global ctx2d
    const ctx = canvas.getContext('2d');
    
    // Fondo degradado
    const gradient = ctx.createRadialGradient(Nx / 2, Ny / 2, 0, Nx / 2, Ny / 2, Nx / 2);
    gradient.addColorStop(0, '#444');
    gradient.addColorStop(1, '#111');
    ctx.fillStyle = gradient;
    ctx.fillRect(0, 0, Nx, Ny);

    // Patrn de prueba
    ctx.strokeStyle = '#aaa';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(Nx / 2, Ny / 2, Nx / 3, 0, Math.PI * 2);
    ctx.stroke();

    ctx.beginPath();
    ctx.moveTo(10, 10);
    ctx.lineTo(Nx - 10, Ny - 10);
    ctx.moveTo(Nx - 10, 10);
    ctx.lineTo(10, Ny - 10);
    ctx.stroke();

    return ctx.getImageData(0, 0, Nx, Ny);
}

// Actualizar tanto canvas2d (imagen) y canvas3d (heightmap/malla)
function updateVisuals(imageData) {
    // Generar heightmap y actualizar malla 3D
    const heightMapFlat = getHeightMapFromImageData(imageData, Nx, Ny);

    // Aplicar colormap SOLO para visualizacin y actualizar canvas 2D con imagen coloreada
    if (currentColormapId === 'constant-color') { 
        // Construir ImageData con RGB original
        const totalPixels = originalWidth * originalHeight;
        const imgDataArray = new Uint8ClampedArray(totalPixels * 4);
        for (let i = 0; i < totalPixels; i++) {
            imgDataArray[i * 4] = originalR[i];
            imgDataArray[i * 4 + 1] = originalG[i];
            imgDataArray[i * 4 + 2] = originalB_[i];
            imgDataArray[i * 4 + 3] = 255;
        }
        const originalRGBImageData = new ImageData(imgDataArray, originalWidth, originalHeight);
        updateCanvas2D(originalRGBImageData);
    } else {
        const coloredImageData = currentColormapId === 'constant-chrominance'
            ? applyOriginalLabColormapToImage(imageData, originala, originalb, originalWidth, originalHeight)
            : applyColormap(imageData, currentColormapId);
        updateCanvas2D(coloredImageData);
    }

    if (!meshGroup) {
        // Crear malla por primera vez
        meshGroup = createHeightMesh(heightMapFlat, Nx, Ny, false, 1, false, false);
        scene.add(meshGroup);
        const mesh = meshGroup.getObjectByName('mesh');
        if (mesh) mesh.visible = meshCheck.checked; 
        meshGeometry = mesh.geometry;
        positionAttribute = meshGeometry.attributes.position;
        const wireframe = meshGroup.getObjectByName("wireframe"); // Configurar wireframe inicial
        if (wireframe) wireframe.visible = wireframeCheck.checked;
    } else {
        // Actualizar malla existente (incluyendo wireframe)
        updateMeshGeometry(heightMapFlat);
    }

    // Actualizar colores (DESPUS de haber computado las altura con la imagen en gris, 
    // que es en la que se resuelve la PDE) de vrtices para la malla 3D
    updateMeshColors(heightMapFlat, currentColormapId);
}

function updateMeshGeometry(heightMapFlat) {
    const posArr = positionAttribute.array;

    if (posArr.length !== Nx * Ny * 3) {
        console.error("Tamao de los datos no coincide con la geometra.");
        return;
    }

    if (normalizeHeights) {
        // Clculo de rango dinmico (sin percentiles... ver createHeightMesh())
        let min, max, range;
        min = Math.min(...heightMapFlat);
        max = Math.max(...heightMapFlat);
        range = max - min || 1; // Evitar divisin por cero

        // Actualizar directamente la componente Z (altura) en el array con normalizacin
        for (let j = 0; j < Ny; j++) {
            for (let i = 0; i < Nx; i++) {
                const index = j * Nx + i;
                const arrayIndex = index * 3;
                const normalizedHeight = (heightMapFlat[index] - min) / range;
                const height = normalizedHeight * 1.0;
                posArr[arrayIndex + 2] = height;
            }
        }
    } else {
        // Actualizar directamente la componente Z (altura) en el array sin normalizacin
        for (let j = 0; j < Ny; j++) {
            for (let i = 0; i < Nx; i++) {
                const index = j * Nx + i;
                const arrayIndex = index * 3;
                posArr[arrayIndex + 2] = heightMapFlat[index];
            }
        }
    }

    meshGeometry.computeVertexNormals();

    // Actualizar wireframe
    const wireframe = meshGroup.getObjectByName("wireframe");
    if (wireframe) {
        wireframe.geometry.attributes.position.copy(positionAttribute);
        wireframe.geometry.attributes.position.needsUpdate = true;
        wireframe.geometry.computeVertexNormals();
    }

    needToUpdate = true;
}

function updateCanvas2D(imageData) {
    const w = imageData.width;
    const h = imageData.height;
    canvas2d.width = w;
    canvas2d.height = h;
    ctx2d.putImageData(imageData, 0, 0);
}

function updateMeshColors(heightMapFlat, colormapId) {
    if (!meshGeometry || !meshGeometry.attributes.color) return;
    
    if (!meshGeometry.attributes.color) { // Si no existe el atributo color, lo creamos
        const colors = new Float32Array(Nx * Ny * 3);
        meshGeometry.setAttribute('color', new THREE.BufferAttribute(colors, 3));
    }

    const colorAttribute = meshGeometry.attributes.color;
    const colorArr = colorAttribute.array;

    if (colormapId === 'constant-color' || colormapId === 'constant-chrominance') {
        for (let j = 0; j < Ny; j++) {
            for (let i = 0; i < Nx; i++) {
                const meshIndex = j * Nx + i;
                const arrayIndex = meshIndex * 3;   // ndice para la malla, de tamao NxxNy

                // Calcular posicin relativa en la imagen original
                const relX = i / (Nx - 1);
                const relY = j / (Ny - 1);
                
                // Mapear a coordenadas de la imagen original, de tamao originalWidthxoriginalHeight
                const origX = Math.floor(relX * (originalWidth - 1));
                const origY = Math.floor(relY * (originalHeight - 1));
                const origIndex = origY * originalWidth + origX;

                if (colormapId === 'constant-color') {
                    // A Three.js se le pasan colores en [0, 1]
                    colorArr[arrayIndex] = originalR[origIndex] / 255.0;
                    colorArr[arrayIndex + 1] = originalG[origIndex] / 255.0;
                    colorArr[arrayIndex + 2] = originalB_[origIndex] / 255.0;
                } else {
                    const heightValue = heightMapFlat[meshIndex];
                    const L_val = heightValue * 100.0; // L en [0, 100]
                    const a_val = originala ? originala[origIndex] : 0;
                    const b_val = originalb ? originalb[origIndex] : 0;
                    const [r, g, b] = labToRgb(L_val, a_val, b_val);
                    colorArr[arrayIndex] = r;
                    colorArr[arrayIndex + 1] = g;
                    colorArr[arrayIndex + 2] = b;
                }
            }
        }
    } else {
        // Resto de colormaps 
        const colormap = colors255[colormapId];
        for (let j = 0; j < Ny; j++) {
            for (let i = 0; i < Nx; i++) {
                const index = j * Nx + i;
                const arrayIndex = index * 3;
                const heightValue = heightMapFlat[index]; // Valor en [0, 1]

                // Convertir a ndice de colormap [0, 255]
                const colorIndex = Math.min(255, Math.max(0, Math.floor(heightValue * 255)));

                // Colorear el vrtice
                const color = colormap[colorIndex];
                colorArr[arrayIndex] = color[0];     // R
                colorArr[arrayIndex + 1] = color[1]; // G
                colorArr[arrayIndex + 2] = color[2]; // B
            }
        }
    }
    
    colorAttribute.needsUpdate = true;
}

function createAxes() {
    const materialX = new THREE.LineBasicMaterial({ color: 0xff0000 });
    const materialY = new THREE.LineBasicMaterial({ color: 0x00ff00 });
    const materialZ = new THREE.LineBasicMaterial({ color: 0x0000ff });

    const geometryX = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(5, 0, 0)
    ]);
    const xAxis = new THREE.Line(geometryX, materialX);

    const geometryY = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(0, 2.5, 0)
    ]);
    const yAxis = new THREE.Line(geometryY, materialY);

    const geometryZ = new THREE.BufferGeometry().setFromPoints([
        new THREE.Vector3(0, 0, 0),
        new THREE.Vector3(0, 0, 5)
    ]);
    const zAxis = new THREE.Line(geometryZ, materialZ);

    return { x: xAxis, y: yAxis, z: zAxis };
}

function toggleWireframe(event) {
    const wireframe = meshGroup?.getObjectByName("wireframe");
    if (wireframe) {
        wireframe.visible = event.target.checked;
    }
}

function toggleMesh(event) {
    const mesh = meshGroup?.getObjectByName("mesh");
    if (mesh) {
        mesh.visible = event.target.checked;
    }
}

function toggleRun(event) {
    runSimulation = event.target.checked;
}

function handleResize() {
    camera.aspect = window.innerWidth / window.innerHeight;
    camera.updateProjectionMatrix();
    renderer.setSize(window.innerWidth, window.innerHeight);
}

function handleImageUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();

    reader.onload = function(e) {
        const imgElement = new Image();
        imgElement.onload = () => {
            // Guardar dimensiones ORIGINALES
            originalWidth = imgElement.width;
            originalHeight = imgElement.height;

            const { imageData, aData, bData } = preprocessImageToGrayscale(imgElement, Nx, Ny);
            originalImageData = imageData;
            originala = aData;
            originalb = bData;

            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d'); 
            canvas.width = originalWidth;  
            canvas.height = originalHeight; 
            ctx.drawImage(imgElement, 0, 0, canvas.width, canvas.height);
            const originalRGB = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const totalPixels = originalWidth * originalHeight;
            originalR = new Float32Array(totalPixels);
            originalG = new Float32Array(totalPixels);
            originalB_ = new Float32Array(totalPixels);
            for (let i = 0; i < totalPixels; i++) {
                originalR[i] = originalRGB.data[i * 4];      
                originalG[i] = originalRGB.data[i * 4 + 1];
                originalB_[i] = originalRGB.data[i * 4 + 2];
            }

            currentImageData = originalImageData;
            initializeSimulation();
        };
        imgElement.src = e.target.result;
    };

    reader.readAsDataURL(file);
}

function handleBoundaryChange(event) {
    if (solver) {
        solver.setBoundaryType(event.target.value);
    }
}

function handlePDEChange(event) {
    if (solver) {
        solver.setPDEType(event.target.value);
    }

    updateEquationDisplay(event.target.value);
}

function handleSchemeChange(event) {
    if (solver) {
        solver.setSchemeType(event.target.value);
    }
}

function handleColormapChange(event) {
    currentColormapId = event.target.value;
    updateVisuals(currentImageData);
}

function setVelocity(event) {
    const value = event.target.value;
    velocityValue.textContent = speedAnimation = value;
}

function setInitialCondition() {
    // Restaurar imagen y solver
    currentImageData = originalImageData;

    if (solver) {
        solver.reset();
    }

    // Eliminar la malla anterior para evitar problemas
    if (meshGroup) {
        scene.remove(meshGroup);
        meshGroup.geometry?.dispose();
        meshGroup.material?.dispose();
        meshGroup = null;
        meshGeometry = null;
        positionAttribute = null;
    }

    initializeSimulation();
}

function updateEquationDisplay(pdeType) {
    const equationSection = document.getElementById('equations-section');
    
    if (pdeType === 'heat') {
        equationSection.innerHTML = `
            <h2>Current PDE</h2>
            <p>
                $$ \\frac{\\partial u}{\\partial t} = \\alpha \\nabla^2 u $$
            </p>
        `;
    } else if (pdeType === 'exponential-decay') {
        equationSection.innerHTML = `
            <h2>Current PDE</h2>
            <p>
                $$ \\frac{\\partial u}{\\partial t} = -\\lambda u $$
            </p>
        `;
    } else {
        equationSection.innerHTML = `
            <h2>Current PDE</h2>
            <p>
                $$ \\frac{\\partial^2 u}{\\partial t^2} = c^2 \\nabla^2 u $$
            </p>
        `;
    }
    
    // Volver a renderizar MathJax
    MathJax.typesetPromise();
}

function saveImage() {
    // Crear un canvas temporal con el tamao original de canvas2d
    const tempCanvas = document.createElement('canvas');
    tempCanvas.width = originalWidth;
    tempCanvas.height = originalHeight;
    const tempCtx = tempCanvas.getContext('2d');

    
    // Generar los datos de imagen segn el colormap actual
    if (currentColormapId === 'constant-color') {
        // Construir ImageData con RGB original
        const imgDataArray = new Uint8ClampedArray(originalWidth * originalHeight * 4);
        for (let i = 0; i < originalWidth * originalHeight; i++) {
            imgDataArray[i * 4] = originalR[i];
            imgDataArray[i * 4 + 1] = originalG[i];
            imgDataArray[i * 4 + 2] = originalB_[i];
            imgDataArray[i * 4 + 3] = 255;
        }
        const originalRGBImageData = new ImageData(imgDataArray, originalWidth, originalHeight);
        tempCtx.putImageData(originalRGBImageData, 0, 0);
    } 
    else if (currentColormapId === 'constant-chrominance') {
        // Obtener heightmap actual
        const heightMapFlat = getHeightMapFromImageData(currentImageData, Nx, Ny);
        
        // Generar imagen Lab a resolucin original
        const labImageData = applyOriginalLabColormapToImageFullRes(
            heightMapFlat, 
            originala, 
            originalb, 
            originalWidth, 
            originalHeight,
            Nx,
            Ny
        );
        tempCtx.putImageData(labImageData, 0, 0);
    } 
    else {
        // Para otros colormaps, escalamos la imagen actual a la resolucin original
        const coloredImageData = applyColormap(currentImageData, currentColormapId);
        
        // Crear un canvas temporal para el escalado
        const tempCanvas2 = document.createElement('canvas');
        tempCanvas2.width = currentImageData.width;
        tempCanvas2.height = currentImageData.height;
        const tempCtx2 = tempCanvas2.getContext('2d');
        tempCtx2.putImageData(coloredImageData, 0, 0);
        
        // Dibujar escalado al tamao original
        tempCtx.drawImage(tempCanvas2, 0, 0, originalWidth, originalHeight);
    }   

    let filename = prompt('Enter the file name (without extension):', `image_${tempCanvas.width}x${tempCanvas.height}`);
    if (!filename) return;

    // Generar el data URL del canvas
    const ext = 'png';
    const mimeType = 'image/png';
    tempCanvas.toBlob((blob) => {
        if (!blob) {
            alert('Error generating image.');
            return;
        }

        // Crear enlace temporal para descarga
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `${filename}.${ext}`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }, mimeType);
}

// Volver a valores por defecto iniciales de los checkbox al recargar la pgina
window.addEventListener('load', () => {
    const checkboxes = document.querySelectorAll('input[type="checkbox"]');
    checkboxes.forEach(cb => {
        cb.checked = cb.defaultChecked;
    });

    wireframeCheck.dispatchEvent(new Event('change'));
    meshCheck.dispatchEvent(new Event('change'));
    runCheck.dispatchEvent(new Event('change'));

    fileUpload.value = '';

    document.getElementById('colormap-select').value = 'viridis';
    document.getElementById('pde-select').value = 'wave';
    document.getElementById('boundary-select').value = 'reflective';
    document.getElementById('scheme-select').value = 'forward-euler';
    document.getElementById('speed-slider').value = 50;
});

window.addEventListener('keydown', (event) => {
const key = event.key.toLowerCase();

  if (key === 'e') {
    toggledE = !toggledE;

    if (toggledE) {
      // Modo pantalla completa 3D
      canvas3dContainer.style.position = 'fixed';
      canvas3dContainer.style.top = '0';
      canvas3dContainer.style.left = '0';
      canvas3dContainer.style.width = '100vw';
      canvas3dContainer.style.height = '100vh';
      canvas3dContainer.style.zIndex = '9999';

      // Ocultar todo lo dems
      document.getElementById('main-container').style.display = 'none';
      document.getElementById('canvas2d-section').style.display = 'none';
    } else {
      // Volver a modo normal
      canvas3dContainer.style.position = '';
      canvas3dContainer.style.top = '';
      canvas3dContainer.style.left = '';
      canvas3dContainer.style.width = '';
      canvas3dContainer.style.height = '';
      canvas3dContainer.style.zIndex = originalZ;

      document.getElementById('main-container').style.display = '';
      document.getElementById('canvas2d-section').style.display = '';
    }

    axes.x.visible = !axes.x.visible;
    axes.y.visible = !axes.y.visible;
    axes.z.visible = !axes.z.visible;
  }

  if (key === 'r') {
    runCheck.click();
  }
  
  if (key === 's') {
    saveImage();
  }
  
    if (key === 'n') {
    normalizeHeights = !normalizeHeights;

    const indicator = document.getElementById('normalization-indicator');
    if (normalizeHeights) {
        indicator.style.display = 'block';
    } else {
        indicator.style.display = 'none';
    }
    }

  if (key === '') {
    console.log("Has descubierto un easter egg! Entre t y yo: aplica la ecuacin de calor con Constant Color, condiciones Zero, y descubrirs el modo 'cojn'");
  }
});
